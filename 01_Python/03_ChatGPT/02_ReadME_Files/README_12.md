# Extracted Messages - Part 12

|      | id                                   | author_role   |   create_time | content                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | status                | parent                               |
|-----:|:-------------------------------------|:--------------|--------------:|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:----------------------|:-------------------------------------|
| 1100 | 174f79b3-0cb1-4408-8165-6d7d7137b1ad | assistant     |   1.68979e+09 | I can see there's a bit of confusion. Let's clarify the code snippet you provided.                                                                                                                                                                                                                                                                                                                                                                                               | finished_successfully | 3e16a46c-7f93-4b69-9fa7-0d475f241055 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | In the Python Flask application, `app = Flask(__name__)` is creating a new instance of the Flask web framework, where `__name__` is a special variable in Python that gets as value the string `"__main__"` when you’re executing the script, and it helps Flask know where it can find other resources such as templates.                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | The `@app.route('/api/your_endpoint', methods=['POST'])` decorator tells Flask what URL should trigger the following function `handle_request()`. Here, it's specifying that if the Flask app receives a POST request at the URL `/api/your_endpoint`, it should run the `handle_request()` function.                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Now, within the `handle_request()` function, `data = request.json` is getting the data sent in the POST request. Here's the process:                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | **Sending Data to Your API**                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | The data for `request.json` comes from a POST request sent to your API. For example, let's say you're using a tool like Postman to test your API. You would:                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 1. Set the URL to your Flask app's URL, with the `/api/your_endpoint` at the end (e.g., `http://localhost:5000/api/your_endpoint` or your deployed app's URL if deployed).                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 2. Set the request method to POST.                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 3. In the 'Body' tab, select 'raw' and 'JSON', and then you can enter the data you want to send in JSON format, like:                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     ```json                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     {                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |         "field1": "value1",                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |         "field2": "value2"                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     }                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 4. Click 'Send' to send the request. This will send a POST request to your API with the JSON data in the body of the request. This is the data that `request.json` in your Flask app is getting.                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | **Receiving Data in Qlik Sense**                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | On the Qlik Sense side, when you're setting up the REST connection, in the 'Body' field you would also enter the data you want to send to the API in JSON format. The data you enter here would be the data received by `request.json`.                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Remember to replace `'your_endpoint'` with the actual endpoint you want. The specific data you send will depend on what your Python script is expecting and what you want it to do.                                                                                                                                                                                                                                                                                              |                       |                                      |
| 1101 | e4f05a72-0e9f-4ef8-b280-49a581dfc4f6 | user          |   1.68979e+09 | And where i can add my python script                                                                                                                                                                                                                                                                                                                                                                                                                                             | finished_successfully | 174f79b3-0cb1-4408-8165-6d7d7137b1ad |
| 1102 | 51edb4ca-4c5a-4ce6-9354-0406ab47d4c9 | assistant     |   1.68979e+09 | Your Python script will be added in the `handle_request()` function of the Flask application, which is triggered when a POST request is sent to your specified endpoint (`'/api/your_endpoint'`).                                                                                                                                                                                                                                                                                | finished_successfully | e4f05a72-0e9f-4ef8-b280-49a581dfc4f6 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Let's say you have a Python script that performs some data analysis on a dataframe. Here's how you might incorporate it into the Flask app:                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | from flask import Flask, request, jsonify                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import pandas as pd                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Import your custom Python module with your data analysis functions                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | # Replace 'my_module' with your actual module name                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | import my_module                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | app = Flask(__name__)                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | @app.route('/api/your_endpoint', methods=['POST'])                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | def handle_request():                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     data = request.json                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # Convert the JSON data into a DataFrame                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     df = pd.DataFrame(data)                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # Use your Python script to do something with the df                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     # Call the function from your module that performs the data analysis                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     # Replace 'my_function' with your actual function name                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     result_df = my_module.my_function(df)                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # Convert the DataFrame back into JSON                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     result = result_df.to_json(orient='split')                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     return jsonify(result)                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | if __name__ == '__main__':                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     app.run(port=5000)                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Replace `'my_module'` and `'my_function'` with the actual names of your Python module and function. This code assumes that your function takes a dataframe as input and returns a dataframe as output.                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Save this Flask app with a `.py` extension, such as `app.py`, in the same directory where your Python module file is located.                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Now when you send a POST request to the endpoint with JSON data, the Flask app will convert that data into a dataframe, pass it to your Python script, and then return the resulting dataframe as JSON.                                                                                                                                                                                                                                                                          |                       |                                      |
| 1103 | edd5aecd-4ed0-488c-94a9-b259f42f56de | system        |   1.68978e+09 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | finished_successfully | aaa14c64-7c66-4626-a0ff-2cae48629b48 |
| 1104 | aaa2aa6b-49a7-4503-a5ac-fd44ba051a1c | user          |   1.68978e+09 | how i can grap table from webpage using Alteryx                                                                                                                                                                                                                                                                                                                                                                                                                                  | finished_successfully | edd5aecd-4ed0-488c-94a9-b259f42f56de |
| 1105 | 740d2ec1-0942-4d9a-835c-50dc1e556e9f | assistant     |   1.68978e+09 | Alteryx is a powerful tool used for data blending and advanced data analytics. However, directly scraping a webpage is not one of the built-in capabilities that Alteryx provides. If you want to extract tables from a webpage, you'll need to use other tools or programming languages, like Python with libraries such as Beautiful Soup or Scrapy, then import that data into Alteryx for further processing and analysis.                                                   | finished_successfully | aaa2aa6b-49a7-4503-a5ac-fd44ba051a1c |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Here's a general outline on how you could accomplish this:                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 1. **Python Web Scraping**: Write a Python script that uses the `requests` library to fetch the webpage, and then parse the page using `Beautiful Soup` or `Scrapy` to find and extract the table data.                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 2. **Save Data**: After extracting the table data, you should save it in a format that can be easily imported into Alteryx. CSV is a common choice.                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 3. **Alteryx Processing**: Now, you can import the saved CSV file into Alteryx for further analysis and processing.                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | However, if you are focused on using Alteryx, you can use Alteryx's Download Tool to download the HTML of a webpage and then you would have to parse the HTML within Alteryx. Here are the steps:                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 1. **Use the Text Input tool**: This tool allows you to specify the URL you want to scrape.                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 2. **Use the Download tool**: Connect the Text Input tool to a Download tool. The Download tool will connect to the URL and download all the HTML.                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 3. **Use the Regex tool**: Connect the Download tool to a RegEx tool to parse the HTML. You will need to know some regular expressions to extract the data you want.                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 4. **Use the Parse tool**: Connect the RegEx tool to a Parse tool to structure the data into a table.                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Please note, web scraping should always respect the target site's robots.txt file and terms of service, and should not be used to gather sensitive or private information.                                                                                                                                                                                                                                                                                                       |                       |                                      |
| 1106 | aaa2f2f2-6d66-4fe6-b53c-f2c4c5b6c15e | user          |   1.68978e+09 | HTTP/1.1 302 Found                                                                                                                                                                                                                                                                                                                                                                                                                                                               | finished_successfully | 740d2ec1-0942-4d9a-835c-50dc1e556e9f |
| 1107 | a0e22f9b-71fc-40b5-b2bf-fa5ab8dce6d9 | assistant     |   1.68978e+09 | HTTP/1.1 302 Found is a status code that indicates that the requested resource resides temporarily under a different URL. This status code is commonly used when a website has moved to a new location and the server is directing the client to get the requested resource from that new location.                                                                                                                                                                              | finished_successfully | aaa2f2f2-6d66-4fe6-b53c-f2c4c5b6c15e |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | For example, if you request www.example.com and it has moved to www.example2.com, you might receive a 302 status code along with a Location header field containing the URL of the new location (www.example2.com). Your browser would then make a new request to the URL provided in the Location header.                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Here is a sample of what a 302 redirect might look like:                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | HTTP/1.1 302 Found                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | Location: http://www.example2.com                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | When handling HTTP status codes in a program, you'll need to create code to handle these redirects if the library you're using doesn't automatically do so. This usually involves making a new HTTP request to the URL provided in the Location header after receiving a 302 status code.                                                                                                                                                                                        |                       |                                      |
| 1108 | de5fc7e0-b99c-407f-84ad-e9094a16ab8f | system        |   1.68978e+09 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | finished_successfully | aaa173d2-5dab-411d-b6fd-110c49b984df |
| 1109 | aaa2de40-9ea0-4e42-862a-bb4c980fc537 | user          |   1.68978e+09 | plase adjust below python code by removing the function :                                                                                                                                                                                                                                                                                                                                                                                                                        | finished_successfully | de5fc7e0-b99c-407f-84ad-e9094a16ab8f |
|      |                                      |               |               | import requests                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | import pandas as pd                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | from cryptography.fernet import Fernet                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # The key provided by the developer/administrator                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | key = b'RrYxdoLBdQUCnYOYRULXzzugb8Uxda_7qBRPizeiKxs='  # replace with the actual key                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Decrypt the message                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | def decrypt_message(encrypted_message, key):                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     f = Fernet(key)                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     decrypted_message = f.decrypt(encrypted_message)                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     return decrypted_message.decode()                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # The encrypted data provided by the developer/administrator                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | encrypted_auth_url = b'gAAAAABktoEdzCVtDIRV1v5_LwCgME9vA1ZftSDFGumznGFgdvlBljwqNkEUkahoPw1Ss9cyryMcAJADGINS_ib6s7go4v7nq820olnZv0OZnN0PLiuibV2xMd4v7qEOlDtAKpC3La23'  # replace with the actual encrypted URL                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | encrypted_auth_data = b'gAAAAABktoEdsR3Q8qe7ynEs9G0-9eFn7xqWmL4_iYA0Tdu36pydeKQv1dxi3QudbGW_ZtrpRTev6uGi75pBU9U9uWvdk10gQIlkfQhrgAqHdndFGqi7RJqiB9STlvqtFYTvtAwz02b6HPkKdU8lGjKYPCqS5zV8Yz_tFDUKIgldZSemfHYl_4TjyBEOXxpd4yRYI7VA_vlTQtRVMwmI8h5yQBSAMfMRHg=='  # replace with the actual encrypted data                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Decrypt auth_url and auth_data when needed                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | decrypted_auth_url = decrypt_message(encrypted_auth_url, key)                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | decrypted_auth_data = eval(decrypt_message(encrypted_auth_data, key))                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | auth_data_str = '&'.join(f'{k}={v}' for k, v in decrypted_auth_data.items())                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | auth_response = requests.post(decrypted_auth_url, data=auth_data_str)                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | auth_response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | token = auth_response.json()['access_token']                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | df = pd.DataFrame()                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | print(df)                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | print(decrypted_auth_url)                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | print(decrypted_auth_data)                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | print(auth_data_str)                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
| 1110 | a85be526-4b19-4b47-97d9-a2ed8d84dae3 | assistant     |   1.68978e+09 | Sure, I can refactor the code to remove the function and include its logic directly in the main part of the script. Here's the adjusted code:                                                                                                                                                                                                                                                                                                                                    | finished_successfully | aaa2de40-9ea0-4e42-862a-bb4c980fc537 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import requests                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | import pandas as pd                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | from cryptography.fernet import Fernet                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # The key provided by the developer/administrator                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | key = b'RrYxdoLBdQUCnYOYRULXzzugb8Uxda_7qBRPizeiKxs='  # replace with the actual key                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # The encrypted data provided by the developer/administrator                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | encrypted_auth_url = b'gAAAAABktoEdzCVtDIRV1v5_LwCgME9vA1ZftSDFGumznGFgdvlBljwqNkEUkahoPw1Ss9cyryMcAJADGINS_ib6s7go4v7nq820olnZv0OZnN0PLiuibV2xMd4v7qEOlDtAKpC3La23'  # replace with the actual encrypted URL                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | encrypted_auth_data = b'gAAAAABktoEdsR3Q8qe7ynEs9G0-9eFn7xqWmL4_iYA0Tdu36pydeKQv1dxi3QudbGW_ZtrpRTev6uGi75pBU9U9uWvdk10gQIlkfQhrgAqHdndFGqi7RJqiB9STlvqtFYTvtAwz02b6HPkKdU8lGjKYPCqS5zV8Yz_tFDUKIgldZSemfHYl_4TjyBEOXxpd4yRYI7VA_vlTQtRVMwmI8h5yQBSAMfMRHg=='  # replace with the actual encrypted data                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Create a new Fernet object                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | f = Fernet(key)                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Decrypt auth_url and auth_data directly without using a function                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | decrypted_auth_url = f.decrypt(encrypted_auth_url).decode()                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | decrypted_auth_data = eval(f.decrypt(encrypted_auth_data).decode())                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | auth_data_str = '&'.join(f'{k}={v}' for k, v in decrypted_auth_data.items())                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | auth_response = requests.post(decrypted_auth_url, data=auth_data_str)                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | auth_response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | token = auth_response.json()['access_token']                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | df = pd.DataFrame()                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | print(df)                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | print(decrypted_auth_url)                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | print(decrypted_auth_data)                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | print(auth_data_str)                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | This version does essentially the same thing, but without using the function to decrypt the data. Instead, the Fernet object is created directly in the script and used to decrypt the data.                                                                                                                                                                                                                                                                                     |                       |                                      |
| 1111 | cc185373-5b4e-49e0-afcf-253a3573f360 | system        |   1.68976e+09 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | finished_successfully | aaa1413a-7f29-464b-905b-d060483c2da2 |
| 1112 | aaa2ba28-f2e0-4ffa-953c-e69e9eed9745 | user          |   1.68976e+09 | I need to adjust the following python API script following below instructions:                                                                                                                                                                                                                                                                                                                                                                                                   | finished_successfully | cc185373-5b4e-49e0-afcf-253a3573f360 |
|      |                                      |               |               | 1.	We created an SQL table sta.PowerBI_Users contains below with example :                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | a.	Region_Name : RSE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | b.	User_ID : IBRAHHO                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | c.	Creation_Date : 19-07-2023                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | d.	Max_API_Calls : 30                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 2.	We created another Table in MS SQL named : [sta].[PowerBI_Calls], below is example :                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | a.	Region_Name : RSE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | b.	User_ID : IBRAHHO                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | c.	Query_ur : https://planx.hlag.com/public/PlanX_CL_Scheme/query/testing2?                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | d.	Call_DateTime : 2023-07-19 00:00:00.000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | e.	No_Of_Calls : 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 3.	When we run the below python API we need to preform below actions:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | a.	First get the windows UserID and make sure that there is an existing UserID has been created on the firs table sta.PowerBI_Users otherwise we need an Pandas Dataframe called df_error having one column “Permission” and one row “you don’t have permission to execute the API calls”                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | b.	Second after the first one has been checked then if there is no Entry for that Spesfic UserID and Region_Name on Table [sta].[PowerBI_Calls], we need to run the python code for getting the API request and passed into Pandas Dataframe called df and go to to step (d)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | c.	 If already enetry has been existing on table [sta].[PowerBI_Calls], make sure by selecting the Region_Name and User_ID from table : [sta].[PowerBI_Calls] that total No_Of_Calls during 24 hours not exceeding the Max_API_Calls from the first table by same Region_Name and User_ID and if exceeded to have Pandas Dataframe called df_error having one column “Permission” and one row “You are already exceduing your daily Calls, please try tomorrow or contact hossam.ibrahim@hlag.com”                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | d.	If the total No_Of_Calls from table  [sta].[PowerBI_Calls] still not reached the Max_API_Calls from first table : sta.PowerBI_Users then we can run the API python script and record below information in table  [sta].[PowerBI_Calls] :                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | i.	Region_Name : “RSE”                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ii.	User_ID : Windows User ID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | iii.	Query_url : api_url                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | iv.	Call_DateTime : date and time of the API python calls                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | v.	No_Of_Calls : count the number of get request that has been sent to api_url                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Below is the python code that need to be adjusted and please write the full code having above                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | import requests                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | import pandas as pd                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | import time                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | auth_url = 'https://planx.hlag.com/identity/connect/token'                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | auth_data = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     'client_id': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     'client_secret': 'abcd',                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     'grant_type': 'client_credentials',                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     'scope': 'public-api',                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | auth_data_str = '&'.join(f'{k}={v}' for k, v in auth_data.items())                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | auth_response = requests.post(auth_url, data=auth_data_str)                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | auth_response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | token = auth_response.json()['access_token']                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | df = pd.DataFrame()                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | Regions = ['RSE']                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | #versions = ['FC1', 'ACT', 'FC1 INT', 'BU2']                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | def fetch_data(Region):                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     api_url = f'https://planx.hlag.com/public/PlanX_CL_Scheme/query/testing2?year="2023"&Currency="USD"&Region={Region}&Layer 2="HL"&CL Scheme Hierarchy="030"&CL Scheme Type="020"'                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     headers = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |         'Authorization': f'Bearer {token}',                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |         'Client-ID': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     }                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     response = requests.get(api_url, headers=headers)                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     data = response.json()                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     temp_df = pd.DataFrame(data['data'], columns=['Month', 'Version', 'Layer Level 3','Currency', 'CL Scheme', 'Relation', 'REP CL Scheme'])                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     if temp_df.empty:                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |         return None                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     return temp_df                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | for Region in Regions:                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |         temp_df = fetch_data(Region)                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |         if temp_df is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |             df = pd.concat([df, temp_df])                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | del temp_df                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | df                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
| 1113 | 1fc87ce5-187a-487d-8ef2-5504ead8e364 | assistant     |   1.68976e+09 | To fulfill your requirements, you would need to use a SQL Python package such as `pyodbc` or `sqlalchemy` to connect to your MS SQL database and execute the necessary SQL queries. Below is the modified script:                                                                                                                                                                                                                                                                | finished_successfully | aaa2ba28-f2e0-4ffa-953c-e69e9eed9745 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import requests                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | import pandas as pd                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import time                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | import getpass                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | import datetime                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'your_server'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | database = 'your_database'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | username = 'your_username'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | password = 'your_password'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Authentication                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | auth_url = 'https://planx.hlag.com/identity/connect/token'                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | auth_data = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     'client_id': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     'client_secret': 'abcd',                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     'grant_type': 'client_credentials',                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     'scope': 'public-api',                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | auth_data_str = '&'.join(f'{k}={v}' for k, v in auth_data.items())                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | auth_response = requests.post(auth_url, data=auth_data_str)                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | auth_response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | token = auth_response.json()['access_token']                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Regions = ['RSE']                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | df = pd.DataFrame()                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # get windows userID                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | userID = getpass.getuser()                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | def fetch_data(Region, userID):                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     cursor.execute(f"SELECT * FROM sta.PowerBI_Users WHERE User_ID = '{userID}' AND Region_Name = '{Region}'")                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     row = cursor.fetchone()                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # check user permission                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     if not row:                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |         return pd.DataFrame({"Permission": ["you don’t have permission to execute the API calls"]})                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # get the max api calls                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     max_api_calls = row.Max_API_Calls                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # check the calls already made                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     cursor.execute(f"SELECT * FROM sta.PowerBI_Calls WHERE User_ID = '{userID}' AND Region_Name = '{Region}' AND Call_DateTime > DATEADD(day, -1, GETDATE())")                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     rows = cursor.fetchall()                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     if rows:                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |         total_calls = sum([row.No_Of_Calls for row in rows])                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |         if total_calls >= max_api_calls:                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |             return pd.DataFrame({"Permission": ["You are already exceeding your daily Calls, please try tomorrow or contact hossam.ibrahim@hlag.com"]})                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # get data                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     api_url = f'https://planx.hlag.com/public/PlanX_CL_Scheme/query/testing2?year="2023"&Currency="USD"&Region={Region}&Layer 2="HL"&CL Scheme Hierarchy="030"&CL Scheme Type="020"'                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     headers = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |         'Authorization': f'Bearer {token}',                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |         'Client-ID': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     }                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     response = requests.get(api_url, headers=headers)                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     data = response.json()                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     temp_df = pd.DataFrame(data['data'], columns=['Month', 'Version', 'Layer Level 3','Currency', 'CL Scheme', 'Relation', 'REP CL Scheme'])                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     no_of_calls = 1 # assuming one get request equals one call                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     if not temp_df.empty:                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |         # record api calls                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |         call_date = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |         cursor.execute(f"INSERT INTO sta.PowerBI_Calls (Region_Name, User_ID, Query_url, Call_DateTime, No_Of_Calls) VALUES ('{Region}', '{userID}', '{api_url}', '{call_date}', {no_of_calls})")                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |         cnxn.commit()                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     return temp_df                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | for Region in Regions:                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     temp_df = fetch_data(Region, userID)                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     if temp_df is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |         df = pd.concat([df, temp_df])                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Before using this script, please replace `'your_server'`, `'your_database'`, `'your_username'`, and `'your_password'` with your actual server name, database name, username, and password.                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Please note that this is just a basic implementation and doesn't handle all possible errors. Depending on your actual use case, you might want to add more sophisticated error handling.                                                                                                                                                                                                                                                                                         |                       |                                      |
| 1114 | aaa2152b-f36f-4b11-bd9d-851331d8499a | user          |   1.68977e+09 | can we write above python script in SQL table then retrieve the script from SQL table                                                                                                                                                                                                                                                                                                                                                                                            | finished_successfully | 1fc87ce5-187a-487d-8ef2-5504ead8e364 |
| 1115 | 56f4147c-e01d-4c1b-a71b-dccbfb976547 | assistant     |   1.68977e+09 | Yes, you can store the Python script in a SQL table and then retrieve it. However, this is not a common practice and there are potential security risks if the table where the script is stored can be accessed by unauthorized users, since they could modify the script to include malicious code.                                                                                                                                                                             | finished_successfully | aaa2152b-f36f-4b11-bd9d-851331d8499a |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | That said, if you understand the risks and still want to do it, here is how you could achieve it:                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 1. Create a table in your SQL Server database to hold the Python script. The table could be something like this:                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | CREATE TABLE PythonScripts (                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     ScriptID INT PRIMARY KEY,                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     ScriptText NVARCHAR(MAX)                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | );                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 2. Insert your Python script into the `PythonScripts` table:                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | INSERT INTO PythonScripts (ScriptID, ScriptText)                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | VALUES (1, '... your Python script here ...');                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Replace `'... your Python script here ...'` with your Python script. Make sure to escape any single quotes in your script by replacing `'` with `''`.                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 3. Then, in Python, you can retrieve and execute the script like this:                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'your_server'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | database = 'your_database'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | username = 'your_username'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | password = 'your_password'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Retrieve the script                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cursor.execute('SELECT ScriptText FROM PythonScripts WHERE ScriptID = 1')                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | row = cursor.fetchone()                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | script_text = row.ScriptText                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Execute the script                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | exec(script_text)                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Before using this script, please replace `'your_server'`, `'your_database'`, `'your_username'`, and `'your_password'` with your actual server name, database name, username, and password.                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Please be aware that using `exec` in this way can be dangerous if you don't have complete control over what might be in `script_text`, since it can execute any Python code. Use this with extreme caution!                                                                                                                                                                                                                                                                      |                       |                                      |
| 1116 | aaa21464-82c1-45f4-83ce-8de73e25c7de | user          |   1.68977e+09 | how i can drop the table                                                                                                                                                                                                                                                                                                                                                                                                                                                         | finished_successfully | 56f4147c-e01d-4c1b-a71b-dccbfb976547 |
| 1117 | 8e6e4302-47c6-4e18-8365-c2ba351ea9ca | assistant     |   1.68977e+09 | Dropping (i.e., deleting) a table in SQL is straightforward. You just use the `DROP TABLE` statement, followed by the name of the table you want to drop.                                                                                                                                                                                                                                                                                                                        | finished_successfully | aaa21464-82c1-45f4-83ce-8de73e25c7de |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Here's how you can drop a table in Python using `pyodbc`:                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'your_server'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | database = 'your_database'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | username = 'your_username'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | password = 'your_password'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cursor.execute('DROP TABLE PythonScripts')                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | cnxn.commit()                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Just replace `'PythonScripts'` with the name of the table you want to drop, and replace `'your_server'`, `'your_database'`, `'your_username'`, and `'your_password'` with your actual server name, database name, username, and password.                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Please be careful when using the `DROP TABLE` statement, as it will permanently delete the table and all data stored in it. There is no way to undo this operation.                                                                                                                                                                                                                                                                                                              |                       |                                      |
| 1118 | aaa2c7b3-b079-462b-9f47-c4d9a3e4bd8c | user          |   1.68977e+09 | Started executing query at Line 85                                                                                                                                                                                                                                                                                                                                                                                                                                               | finished_successfully | 8e6e4302-47c6-4e18-8365-c2ba351ea9ca |
|      |                                      |               |               | 	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 	Msg 102, Level 15, State 1, Line 2                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Incorrect syntax near 'import requests                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | import pandas as pd                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import time                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | import getpass                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | import datetime                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | serve'.                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | 	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 	Msg 132, Level 15, State 1, Line 57                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | The label 'https' has already been declared. Label names must be unique within a query batch or stored procedure.                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | 	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 	Total execution time: 00:00:00.015:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | INSERT INTO PythonScripts (ScriptID, Region_Name, Script_Data)                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | VALUES (1,'RSE' 'import requests                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | import pandas as pd                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import time                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | import getpass                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | import datetime                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | database = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | username = 'PowerBI_user'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | password = r'PowerBI\User@Hossam@HQ1611'                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Authentication                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | auth_url = 'https://planx.hlag.com/identity/connect/token'                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | auth_data = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     'client_id': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     'client_secret': 'abcd',                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     'grant_type': 'client_credentials',                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     'scope': 'public-api',                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | auth_data_str = '&'.join(f'{k}={v}' for k, v in auth_data.items())                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | auth_response = requests.post(auth_url, data=auth_data_str)                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | auth_response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | token = auth_response.json()['access_token']                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Regions = ['RSE']                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | df = pd.DataFrame()                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # get windows userID                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | userID = getpass.getuser()                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | def fetch_data(Region, userID):                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     cursor.execute(f"SELECT * FROM sta.PowerBI_Users WHERE User_ID = '{userID}' AND Region_Name = '{Region}'")                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     row = cursor.fetchone()                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # check user permission                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     if not row:                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |         return pd.DataFrame({"Permission": ["you don’t have permission to execute the API calls"]})                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # get the max api calls                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     max_api_calls = row.Max_API_Calls                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # check the calls already made                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     cursor.execute(f"SELECT * FROM sta.PowerBI_Calls WHERE User_ID = '{userID}' AND Region_Name = '{Region}' AND Call_DateTime > DATEADD(day, -1, GETDATE())")                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     rows = cursor.fetchall()                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     if rows:                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |         total_calls = sum([row.No_Of_Calls for row in rows])                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |         if total_calls >= max_api_calls:                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |             return pd.DataFrame({"Permission": ["You are already exceeding your daily Calls, please try tomorrow or contact hossam.ibrahim@hlag.com"]})                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # get data                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     api_url = f'https://planx.hlag.com/public/PlanX_CL_Scheme/query/testing2?year="2023"&Currency="USD"&Region={Region}&Layer 2="HL"&CL Scheme Hierarchy="030"&CL Scheme Type="020"'                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     headers = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |         'Authorization': f'Bearer {token}',                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |         'Client-ID': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     }                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     response = requests.get(api_url, headers=headers)                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     data = response.json()                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     temp_df = pd.DataFrame(data['data'], columns=['Month', 'Version', 'Layer Level 3','Currency', 'CL Scheme', 'Relation', 'REP CL Scheme'])                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     no_of_calls = 1 # assuming one get request equals one call                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     if not temp_df.empty:                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |         # record api calls                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |         call_date = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |         cursor.execute(f"INSERT INTO sta.PowerBI_Calls (Region_Name, User_ID, Query_url, Call_DateTime, No_Of_Calls) VALUES ('{Region}', '{userID}', '{api_url}', '{call_date}', {no_of_calls})")                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |         cnxn.commit()                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     return temp_df                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | for Region in Regions:                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     temp_df = fetch_data(Region, userID)                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     if temp_df is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |         df = pd.concat([df, temp_df])                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | del temp_df                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | df');                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
| 1119 | 35d13331-9c04-4dad-9c38-a08479bef280 | assistant     |   1.68977e+09 | It appears that you're getting an error because the string containing your Python script has both single and double quotes in it, which is causing issues with the SQL syntax. You can avoid this by using triple quotes to define your Python script string in SQL.                                                                                                                                                                                                             | finished_successfully | aaa2c7b3-b079-462b-9f47-c4d9a3e4bd8c |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | The triple quotes will allow the string to span multiple lines and contain both single and double quotes. Here's how you can do it:                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | INSERT INTO PythonScripts (ScriptID, Region_Name, Script_Data)                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | VALUES (1,'RSE', '''                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | ... your Python script here ...                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ''');                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Replace `'... your Python script here ...'` with your actual Python script.                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Make sure to start and end the script with triple single quotes `'''`, and it should be able to handle the rest of the quotes inside the script correctly. This should resolve the syntax error you're getting.                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Remember, all single quotes `'` inside your Python script (not part of a string or comment) should be doubled `''`. For example `f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}'` needs to be `f'DRIVER={{{{ODBC Driver 17 for SQL Server}}}};SERVER={server};DATABASE={database};UID={username};PWD={password}'`.                                                                                                 |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | If the `password` contains a single quote, it also needs to be doubled. For example, if the password is `PowerBI\User@Hossam@HQ1611`, it needs to be `PowerBI\User@Hossam@HQ1611` in the SQL command.                                                                                                                                                                                                                                                                            |                       |                                      |
| 1120 | aaa29229-bf5c-4a8c-9286-dd9a7b894685 | user          |   1.68977e+09 | Message	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | finished_successfully | 35d13331-9c04-4dad-9c38-a08479bef280 |
|      |                                      |               |               | [2:23:52 PM]	Started executing query at Line 90                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 	Msg 102, Level 15, State 1, Line 11                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Incorrect syntax near 'KFICWPNXDBSP01'.                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | 	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 	Msg 132, Level 15, State 1, Line 58                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | The label 'https' has already been declared. Label names must be unique within a query batch or stored procedure.                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | 	                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 	Total execution time: 00:00:00.012                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
| 1121 | 3d7c81aa-19cf-40d2-ae28-7ca1037bf1d6 | assistant     |   1.68977e+09 | The error message suggests there's a syntax error near `KFICWPNXDBSP01`, which is the value you assigned to the `server` variable in the Python script.                                                                                                                                                                                                                                                                                                                          | finished_successfully | aaa29229-bf5c-4a8c-9286-dd9a7b894685 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | The problem is likely that there's a quote or a special character in your Python script that SQL Server doesn't like, as SQL Server has a different way of escaping special characters compared to Python.                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | In this case, I think the problem is that the Python script inside your SQL statement isn't properly escaped. In SQL, you need to escape single quotes by doubling them. And when you have curly braces `{}` in your Python script (which you do), you need to quadruple the braces.                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | So, for instance, this line in your Python script:                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | should become:                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{{{ODBC Driver 17 for SQL Server}}}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | In addition, any single quote `'` in your Python code (outside of a string or comment) should be replaced with two single quotes `''`.                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | This will be a bit tedious, but it's necessary because you're inserting the Python code as a string in an SQL statement, and SQL has its own way of escaping special characters.                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Note that this isn't a usual or recommended way of running Python scripts, as it can lead to confusion and potential security issues. It would be better to store the Python script in a .py file and run it directly from there.                                                                                                                                                                                                                                                |                       |                                      |
| 1122 | aaa266f6-fa74-4db6-b16f-f20d5247df7d | user          |   1.68977e+09 | but i need to insert it in sql table for security reason , so please build the whole insert query and after that how i pull the python script from sql table                                                                                                                                                                                                                                                                                                                     | finished_successfully | 3d7c81aa-19cf-40d2-ae28-7ca1037bf1d6 |
| 1123 | 92968620-1043-462c-aab2-71fd34087d84 | assistant     |   1.68977e+09 | Here is how you would insert the Python script into your SQL table with the necessary escapes for SQL syntax:                                                                                                                                                                                                                                                                                                                                                                    | finished_successfully | aaa266f6-fa74-4db6-b16f-f20d5247df7d |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | INSERT INTO PythonScripts (ScriptID, Region_Name, Script_Data)                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | VALUES (1, 'RSE', 'import requests\n                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | import pandas as pd\n                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | import pyodbc\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | import time\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import getpass\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | import datetime\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | \n                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | # database connection\n                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | server = ''KFICWPNXDBSP01''\n                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | database = ''PlanX''\n                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | username = ''PowerBI_user''\n                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | password = r''PowerBI\\User@Hossam@HQ1611''\n                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f''DRIVER={{{{ODBC Driver 17 for SQL Server}}}};SERVER={server};DATABASE={database};UID={username};PWD={password}'')\n                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | \n                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | # Authentication\n                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | auth_url = ''https://planx.hlag.com/identity/connect/token''\n                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | auth_data = {\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     ''client_id'': ''API_User'',\n                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     ''client_secret'': ''abcd'',\n                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     ''grant_type'': ''client_credentials'',\n                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     ''scope'': ''public-api'',\n                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | }\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | auth_data_str = ''&''.join(f''{k}={v}'' for k, v in auth_data.items())\n                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               | auth_response = requests.post(auth_url, data=auth_data_str)\n                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | auth_response.raise_for_status()\n                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | token = auth_response.json()[''access_token'']\n                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | \n                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | Regions = [''RSE'']\n                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | df = pd.DataFrame()\n                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | \n                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | # get windows userID\n                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | userID = getpass.getuser()\n                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | \n                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | def fetch_data(Region, userID):\n                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     cursor = cnxn.cursor()\n                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     cursor.execute(f""SELECT * FROM sta.PowerBI_Users WHERE User_ID = ''{userID}'' AND Region_Name = ''{Region}''"")\n                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     row = cursor.fetchone()\n                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | \n                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     # check user permission\n                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     if not row:\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |         return pd.DataFrame({""Permission"": [""you don’t have permission to execute the API calls""]})\n                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | \n                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     # get the max api calls\n                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     max_api_calls = row.Max_API_Calls\n                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | \n                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     # check the calls already made\n                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     cursor.execute(f""SELECT * FROM sta.PowerBI_Calls WHERE User_ID = ''{userID}'' AND Region_Name = ''{Region}'' AND Call_DateTime > DATEADD(day, -1, GETDATE())"")\n                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     rows = cursor.fetchall()\n                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | \n                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     if rows:\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |         total_calls = sum([row.No_Of_Calls for row in rows])\n                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |         if total_calls >= max_api_calls:\n                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |             return pd.DataFrame({""Permission"": [""You are already exceeding your daily Calls, please try tomorrow or contact hossam.ibrahim@hlag.com""]})\n                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | \n                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     # get data\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     api_url = f''https://planx.hlag.com/public/PlanX_CL_Scheme/query/testing2?year="2023"&Currency="USD"&Region={Region}&Layer 2="HL"&CL Scheme Hierarchy="030"&CL Scheme Type="020"''\n                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     headers = {\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |         ''Authorization'': f''Bearer {token}'',\n                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |         ''Client-ID'': ''API_User'',\n                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     }\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     response = requests.get(api_url, headers=headers)\n                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     response.raise_for_status()\n                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     data = response.json()\n                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     temp_df = pd.DataFrame(data[''data''], columns=[''Month'', ''Version'', ''Layer Level 3'',''Currency'', ''CL Scheme'', ''Relation'', ''REP CL Scheme''])\n                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     no_of_calls = 1 # assuming one get request equals one call\n                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | \n                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     if not temp_df.empty:\n                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |         # record api calls\n                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |         call_date = datetime.datetime.now().strftime(''%Y-%m-%d %H:%M:%S'')\n                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |         cursor.execute(f""INSERT INTO sta.PowerBI_Calls (Region_Name, User_ID, Query_url, Call_DateTime, No_Of_Calls) VALUES (''{Region}'', ''{userID}'', ''{api_url}'', ''{call_date}'', {no_of_calls})"")\n                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |         cnxn.commit()\n                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | \n                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     return temp_df\n                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | \n                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | for Region in Regions:\n                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     temp_df = fetch_data(Region, userID)\n                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     if temp_df is not None:\n                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |         df = pd.concat([df, temp_df])\n                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | \n                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | del temp_df\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | cnxn.close()\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | df');                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | Note: I have inserted the `\n` linebreaks manually to ensure the proper format of the Python script. If you get errors, please ensure the structure of the Python script is maintained correctly.                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | After inserting the script, to pull the Python script from your SQL table, you                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
| 1124 | aaa2ab14-79b8-4bed-a0e6-d34cc134d7ae | user          |   1.68977e+09 | now please write the python script that having the script from SQL table                                                                                                                                                                                                                                                                                                                                                                                                         | finished_successfully | 92968620-1043-462c-aab2-71fd34087d84 |
| 1125 | f59ad912-4987-4d3f-b85e-a2b140891ac5 | assistant     |   1.68977e+09 | The Python script to retrieve the script stored in the SQL table would look something like this:                                                                                                                                                                                                                                                                                                                                                                                 | finished_successfully | aaa2ab14-79b8-4bed-a0e6-d34cc134d7ae |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'YOUR_SERVER'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | database = 'YOUR_DATABASE'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | username = 'YOUR_USERNAME'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | password = 'YOUR_PASSWORD'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Get Python script from SQL table                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | cursor.execute("SELECT Script_Data FROM PythonScripts WHERE ScriptID = 1 AND Region_Name = 'RSE'")                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | row = cursor.fetchone()                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | if row is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     python_script = row[0]                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     print(python_script)  # Print out the script, or you can do whatever you want with it                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Please replace `'YOUR_SERVER'`, `'YOUR_DATABASE'`, `'YOUR_USERNAME'`, and `'YOUR_PASSWORD'` with your actual database server, database name, username, and password.                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | This script fetches the script data from the `PythonScripts` table where `ScriptID` is 1 and `Region_Name` is 'RSE'. It then prints the script. You can modify this behavior to fit your needs.                                                                                                                                                                                                                                                                                  |                       |                                      |
| 1126 | aaa234e8-0e02-442c-ad9a-4fe231996275 | user          |   1.68977e+09 | then how i can executed ???                                                                                                                                                                                                                                                                                                                                                                                                                                                      | finished_successfully | f59ad912-4987-4d3f-b85e-a2b140891ac5 |
| 1127 | fd93a245-9d16-485e-87b7-989f6a1e5337 | assistant     |   1.68977e+09 | To execute a Python script stored as a string, you can use the `exec` function in Python. However, this should be done with caution as it can pose serious security risks, especially when you are dealing with user-provided or externally-provided scripts.                                                                                                                                                                                                                    | finished_successfully | aaa234e8-0e02-442c-ad9a-4fe231996275 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Here's how you can modify the above script to execute the fetched script:                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'YOUR_SERVER'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | database = 'YOUR_DATABASE'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | username = 'YOUR_USERNAME'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | password = 'YOUR_PASSWORD'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Get Python script from SQL table                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | cursor.execute("SELECT Script_Data FROM PythonScripts WHERE ScriptID = 1 AND Region_Name = 'RSE'")                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | row = cursor.fetchone()                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | if row is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     python_script = row[0]                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     exec(python_script)  # Execute the script                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Again, use this with caution. In an ideal scenario, it's best to avoid `exec` whenever possible, and especially in situations where the script content may come from an untrusted source or could be modified by others. You should strongly validate or sanitize the input, or have controls in place to limit potential abuse. Always understand the security implications before using functions like `exec`.                                                                 |                       |                                      |
| 1128 | aaa2c15e-2183-4041-8fa3-a75364f1a80c | user          |   1.68977e+09 | but i don't get the dataframe df , it gives me the python script , but i need to execute this script                                                                                                                                                                                                                                                                                                                                                                             | finished_successfully | fd93a245-9d16-485e-87b7-989f6a1e5337 |
| 1129 | 7459ea6b-29d9-47c6-a16b-f512bb88cc2b | assistant     |   1.68977e+09 | When you use `exec()` to execute a script stored as a string, the script is executed in its own scope, which means any variables defined within it are not accessible outside of it.                                                                                                                                                                                                                                                                                             | finished_successfully | aaa2c15e-2183-4041-8fa3-a75364f1a80c |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | However, `exec()` accepts optional arguments to specify the global and local scope. By passing a dictionary as the second argument, you can get access to variables defined in the executed script.                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Please check the following code:                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'YOUR_SERVER'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | database = 'YOUR_DATABASE'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | username = 'YOUR_USERNAME'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | password = 'YOUR_PASSWORD'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Get Python script from SQL table                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | cursor.execute("SELECT Script_Data FROM PythonScripts WHERE ScriptID = 1 AND Region_Name = 'RSE'")                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | row = cursor.fetchone()                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | if row is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     python_script = row[0]                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     globals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     locals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     exec(python_script, globals_, locals_)  # Execute the script                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     df = locals_.get('df')  # Access 'df' from executed script                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # Now you can use df                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     print(df)                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | This code executes the script and then retrieves the `df` variable from the executed script. This works if your script defines `df` at the top level of the script.                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Again, be aware of the security implications associated with using `exec`. Ensure the script you're running is trusted and does not contain any malicious code.                                                                                                                                                                                                                                                                                                                  |                       |                                      |
| 1130 | aaa26d43-f54a-4879-9353-77780ddef76f | user          |   1.68977e+09 | Traceback (most recent call last):                                                                                                                                                                                                                                                                                                                                                                                                                                               | finished_successfully | 7459ea6b-29d9-47c6-a16b-f512bb88cc2b |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |   File c:\Users\IBRAHHO\Anaconda3\envs\Prod\lib\site-packages\IPython\core\interactiveshell.py:3505 in run_code                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     exec(code_obj, self.user_global_ns, self.user_ns)                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |   Cell In[4], line 20                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     exec(python_script, globals_, locals_)  # Execute the script                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |   File :1                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |     import requests\n                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |                     ^                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | SyntaxError: unexpected character after line continuation character                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
| 1131 | e6773b82-7e01-40d8-bb8c-fb4f2c28c82f | assistant     |   1.68977e+09 | It looks like there's an issue with the format of the string you retrieved from the database. The newline characters (`\n`) are being interpreted literally instead of as line breaks.                                                                                                                                                                                                                                                                                           | finished_successfully | aaa26d43-f54a-4879-9353-77780ddef76f |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | When you inserted the Python script into the SQL database, it seems like it was stored with literal newline characters (`\n`) instead of actual line breaks. If you directly insert a multiline Python string into SQL, it might not retain the formatting.                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | In order to interpret the newline and other special characters properly, you need to use the `decode()` function from the `codecs` Python library. Here's how you can modify the Python script to use `codecs.decode()`:                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import codecs                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'YOUR_SERVER'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | database = 'YOUR_DATABASE'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | username = 'YOUR_USERNAME'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | password = 'YOUR_PASSWORD'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Get Python script from SQL table                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | cursor.execute("SELECT Script_Data FROM PythonScripts WHERE ScriptID = 1 AND Region_Name = 'RSE'")                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | row = cursor.fetchone()                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | if row is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     python_script = row[0]                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     python_script = codecs.decode(python_script, 'unicode_escape')  # decode the string to interpret special characters                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     globals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     locals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     exec(python_script, globals_, locals_)  # Execute the script                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     df = locals_.get('df')  # Access 'df' from executed script                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # Now you can use df                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     print(df)                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Please be aware that using `exec()` and `codecs.decode()` on untrusted input has security implications. If the script you're running contains untrusted code, it could be exploited for malicious purposes. Always validate and sanitize your inputs, and only execute scripts that come from trusted sources.                                                                                                                                                                   |                       |                                      |
| 1132 | aaa2ec69-1316-4d30-b58c-13eea6c81d68 | user          |   1.68977e+09 | Cell In[6], line 22                                                                                                                                                                                                                                                                                                                                                                                                                                                              | finished_successfully | e6773b82-7e01-40d8-bb8c-fb4f2c28c82f |
|      |                                      |               |               |     exec(python_script, globals_, locals_)  # Execute the script                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |   File :71                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     cursor.execute(f""SELECT * FROM sta.PowerBI_Users WHERE User_ID = '{userID}' AND Region_Name = '{Region}'"")                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |                       ^                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | SyntaxError: invalid syntax                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
| 1133 | 88a31c58-78fc-478d-8a2d-9d1d9ca81656 | assistant     |   1.68977e+09 | It seems like there's an issue with the string formatting in the Python script you're trying to execute. The error message is pointing to a part of the script where an f-string (formatted string literal) is being used.                                                                                                                                                                                                                                                       | finished_successfully | aaa2ec69-1316-4d30-b58c-13eea6c81d68 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | The issue is happening because you are using double quotes `""` around the SQL query string inside an f-string. This isn't valid Python syntax, you should be using single quotes `''` around the SQL query string or escape the internal double quotes like this `\"`.                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Here's a corrected version of the line causing issues:                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | cursor.execute(f"SELECT * FROM sta.PowerBI_Users WHERE User_ID = '{userID}' AND Region_Name = '{Region}'")                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Please correct this in your original script in the database and then fetch and execute it again.                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | As you're executing this script from an SQL database, it is strongly recommended to ensure the accuracy of the Python syntax when inserting it into the database.                                                                                                                                                                                                                                                                                                                |                       |                                      |
| 1134 | aaa24360-a49d-4b88-9c7a-4fd3c3e55c3a | user          |   1.68977e+09 | so how i can update the sql table                                                                                                                                                                                                                                                                                                                                                                                                                                                | finished_successfully | 88a31c58-78fc-478d-8a2d-9d1d9ca81656 |
| 1135 | 77f5614b-1de7-4fad-b26a-ad3bdf32e437 | assistant     |   1.68977e+09 | To update the script in your SQL table, you can use the SQL `UPDATE` statement. Here's an example of how you can do it:                                                                                                                                                                                                                                                                                                                                                          | finished_successfully | aaa24360-a49d-4b88-9c7a-4fd3c3e55c3a |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | UPDATE PythonScripts                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | SET Script_Data = 'your_corrected_python_script_here'                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | WHERE ScriptID = 1 AND Region_Name = 'RSE'                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Just replace `'your_corrected_python_script_here'` with your corrected Python script. You might need to escape special characters in your Python script string depending on your SQL environment.                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Please be aware that running this command will overwrite the current script stored in the table for the specific `ScriptID` and `Region_Name`.                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | After running the above SQL query, you can fetch and execute the Python script again from your Python environment.                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
| 1136 | aaa20c86-8e2d-4dcb-abdb-027acc2bb0f5 | user          |   1.68977e+09 | Cell In[7], line 22                                                                                                                                                                                                                                                                                                                                                                                                                                                              | finished_successfully | 77f5614b-1de7-4fad-b26a-ad3bdf32e437 |
|      |                                      |               |               |     exec(python_script, globals_, locals_)  # Execute the script                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |   File :81                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     return pd.DataFrame({""Permission"": [""you donât have permission to execute the API calls""]})                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |                            ^                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | SyntaxError: invalid syntax                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
| 1137 | b3359e95-2ac9-4f7a-ac3e-315d1c85787c | assistant     |   1.68977e+09 | It seems like the error is coming from the usage of double quotes around dictionary keys and values in the DataFrame creation. This is causing a syntax error in Python.                                                                                                                                                                                                                                                                                                         | finished_successfully | aaa20c86-8e2d-4dcb-abdb-027acc2bb0f5 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | The correct syntax should be as follows:                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | return pd.DataFrame({"Permission": ["you don’t have permission to execute the API calls"]})                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | To update the script in your SQL table, you can use the SQL `UPDATE` statement as follows:                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | ```sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | UPDATE PythonScripts                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | SET Script_Data = 'your_corrected_python_script_here'                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | WHERE ScriptID = 1 AND Region_Name = 'RSE'                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Replace `'your_corrected_python_script_here'` with your corrected Python script. Please make sure to adjust all the other instances where you have used `""` instead of `"`. You might also want to replace `“` and `”` characters with the regular quotation mark `"`.                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | After running the above SQL query, you can fetch and execute the Python script again from your Python environment.                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
| 1138 | aaa23d17-7eff-4688-b7ca-dcf2ae205c03 | user          |   1.68977e+09 | Cell In[13], line 22                                                                                                                                                                                                                                                                                                                                                                                                                                                             | finished_successfully | b3359e95-2ac9-4f7a-ac3e-315d1c85787c |
|      |                                      |               |               |      20 globals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |      21 locals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | ---> 22 exec(python_script, globals_, locals_)  # Execute the script                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |      23 df = locals_.get('df')  # Access 'df' from executed script                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |      25 # Now you can use df                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | File :25                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Error: ('IM012', '[IM012] [Microsoft][ODBC Driver Manager] DRIVER keyword syntax error (0) (SQLDriverConnect)')                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
| 1139 | 7e5ffe5c-d4d4-431f-a467-3356b3393f24 | assistant     |   1.68977e+09 | This error indicates that there's an issue with the connection string used to connect to the SQL Server. The error is raised by the `pyodbc` library when trying to establish a connection.                                                                                                                                                                                                                                                                                      | finished_successfully | aaa23d17-7eff-4688-b7ca-dcf2ae205c03 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Please make sure that your connection string is correctly formatted and all required fields are provided. The error message suggests that there might be a syntax error around the `DRIVER` keyword.                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | This is a general format of a connection string:                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect('DRIVER={your_driver};SERVER=your_server;DATABASE=your_database;UID=your_username;PWD=your_password')                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Make sure to replace `your_driver`, `your_server`, `your_database`, `your_username`, `your_password` with your actual credentials and driver name. If you're using `ODBC Driver 17 for SQL Server`, then the driver part should be `DRIVER={ODBC Driver 17 for SQL Server}`.                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | If you continue to experience issues, please verify that the correct ODBC driver is installed on your machine and is compatible with the version of SQL Server you're connecting to.                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | The Python script in your SQL table should look something like this:                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | server = 'your_server'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | database = 'your_database'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | username = 'your_username'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | password = 'your_password'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | You can then update your script in the SQL table as discussed previously.                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
| 1140 | aaa23d11-53ba-4231-a6f3-11cd8d134bd0 | user          |   1.68977e+09 | the driver is works and everything works peferct as i test the connection in another table in the same machine , could you please regarding all above adjsuteemnt , please adjust anything need to be adjusted in order to execute the script and having the df :                                                                                                                                                                                                                | finished_successfully | 7e5ffe5c-d4d4-431f-a467-3356b3393f24 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import codecs                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | database = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | username = 'PowerBI_user'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | password = r'PowerBI\User@Hossam@HQ1611'                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               | cnxnn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cursorn = cnxnn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Get Python script from SQL table                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | cursorn.execute("SELECT Script_Data FROM [sta].[PowerBI_Script] WHERE ScriptID = 1 AND Region_Name = 'RSE'")                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | row = cursorn.fetchone()                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | if row is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     python_script = row[0]                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     python_script = codecs.decode(python_script, 'unicode_escape')  # decode the string to interpret special characters                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     globals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     locals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     exec(python_script, globals_, locals_)  # Execute the script                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     df = locals_.get('df')  # Access 'df' from executed script                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # Now you can use df                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     print(df)                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cnxnn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
| 1141 | 0639289b-128e-41fc-a82d-92e3df55136a | assistant     |   1.68977e+09 | Based on your latest comment, you are trying to fetch and execute the Python script stored in a SQL Server database. You said that your database connection is working fine and you've already established a connection to your SQL Server database.                                                                                                                                                                                                                             | finished_successfully | aaa23d11-53ba-4231-a6f3-11cd8d134bd0 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Here's the corrected script:                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import codecs                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | database = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | username = 'PowerBI_user'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | password = r'PowerBI\User@Hossam@HQ1611'                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               | cnxnn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cursorn = cnxnn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Get Python script from SQL table                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | cursorn.execute("SELECT Script_Data FROM [sta].[PowerBI_Script] WHERE ScriptID = 1 AND Region_Name = 'RSE'")                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | row = cursorn.fetchone()                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | if row is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     python_script = row[0]                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     python_script = python_script.replace('\\n', '\n')  # Replace \\n with \n to format the script correctly                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     python_script = python_script.replace("\\'", "'")  # Replace \' with ' to format the script correctly                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |     python_script = python_script.replace('\\"', '"')  # Replace \" with " to format the script correctly                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |     globals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     locals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     exec(python_script, globals_, locals_)  # Execute the script                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     df = locals_.get('df')  # Access 'df' from executed script                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # Now you can use df                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     print(df)                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cnxnn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | The modifications include replacing escaped newlines (`\\n`) with actual newlines (`\n`), replacing escaped single quotes (`\'`) with actual single quotes (`'`), and replacing escaped double quotes (`\"`) with actual double quotes (`"`). This should correctly format your Python script string for execution.                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Remember to use this script with caution, as executing scripts from untrusted sources can be a security risk. Always make sure that the scripts you are executing are from a trusted source and do not contain any harmful code.                                                                                                                                                                                                                                                 |                       |                                      |
| 1142 | aaa2152b-115d-415e-b478-13b70b65e72d | user          |   1.68977e+09 | again everything not working , so please find the python script that i need to store in the above table , please adjust the script to be stored correctly in sql table, then we need to call this script in python from that table and return the df:                                                                                                                                                                                                                            | finished_successfully | 0639289b-128e-41fc-a82d-92e3df55136a |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | import requests                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | import pandas as pd                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import time                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | import getpass                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | import datetime                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | database = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | username = 'PowerBI_user'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | password = r'PowerBI\User@Hossam@HQ1611'                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Authentication                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | auth_url = 'https://planx.hlag.com/identity/connect/token'                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | auth_data = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     'client_id': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     'client_secret': 'abcd',                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     'grant_type': 'client_credentials',                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     'scope': 'public-api',                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | auth_data_str = '&'.join(f'{k}={v}' for k, v in auth_data.items())                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | auth_response = requests.post(auth_url, data=auth_data_str)                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | auth_response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | token = auth_response.json()['access_token']                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Regions = ['RSE']                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | df = pd.DataFrame()                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # get windows userID                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | userID = getpass.getuser()                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | def fetch_data(Region, userID):                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     cursor.execute(f"SELECT * FROM sta.PowerBI_Users WHERE User_ID = '{userID}' AND Region_Name = '{Region}'")                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     row = cursor.fetchone()                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # check user permission                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     if not row:                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |         return pd.DataFrame({"Permission": ["you don’t have permission to execute the API calls"]})                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # get the max api calls                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     max_api_calls = row.Max_API_Calls                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # check the calls already made                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     cursor.execute(f"SELECT * FROM sta.PowerBI_Calls WHERE User_ID = '{userID}' AND Region_Name = '{Region}' AND Call_DateTime > DATEADD(day, -1, GETDATE())")                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     rows = cursor.fetchall()                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     if rows:                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |         total_calls = sum([row.No_Of_Calls for row in rows])                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |         if total_calls >= max_api_calls:                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |             return pd.DataFrame({"Permission": ["You are already exceeding your daily Calls, please try tomorrow or contact hossam.ibrahim@hlag.com"]})                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # get data                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     api_url = f'https://planx.hlag.com/public/PlanX_CL_Scheme/query/testing2?year="2023"&Currency="USD"&Region={Region}&Layer 2="HL"&CL Scheme Hierarchy="030"&CL Scheme Type="020"'                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     headers = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |         'Authorization': f'Bearer {token}',                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |         'Client-ID': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     }                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     response = requests.get(api_url, headers=headers)                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     data = response.json()                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     temp_df = pd.DataFrame(data['data'], columns=['Month', 'Version', 'Layer Level 3','Currency', 'CL Scheme', 'Relation', 'REP CL Scheme'])                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     no_of_calls = 1 # assuming one get request equals one call                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     if not temp_df.empty:                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |         # record api calls                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |         call_date = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |         cursor.execute(f"INSERT INTO sta.PowerBI_Calls (Region_Name, User_ID, Query_url, Call_DateTime, No_Of_Calls) VALUES ('{Region}', '{userID}', '{api_url}', '{call_date}', {no_of_calls})")                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |         cnxn.commit()                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     return temp_df                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | for Region in Regions:                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     temp_df = fetch_data(Region, userID)                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     if temp_df is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |         df = pd.concat([df, temp_df])                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | del temp_df                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | df                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
| 1143 | 8859a8e8-1325-438a-bb8f-90094a3104ab | assistant     |   1.68977e+09 | The script you posted contains special characters like single and double quotes, and newlines, which can cause issues when storing and retrieving the script from a SQL table. We need to store it as a single line, escape the special characters, and remove unnecessary indents.                                                                                                                                                                                              | finished_successfully | aaa2152b-115d-415e-b478-13b70b65e72d |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | The modified script is as follows:                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | script = (                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "import requests\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "import pandas as pd\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "import pyodbc\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     "import time\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "import getpass\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     "import datetime\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "server = 'KFICWPNXDBSP01'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "database = 'PlanX'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "username = 'PowerBI_user'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "password = r'PowerBI\User@Hossam@HQ1611'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     "cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')\n"                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     "auth_url = 'https://planx.hlag.com/identity/connect/token'\n"                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "auth_data = {'client_id': 'API_User','client_secret': 'abcd','grant_type': 'client_credentials','scope': 'public-api',}\n"                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     "auth_data_str = '&'.join(f'{k}={v}' for k, v in auth_data.items())\n"                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "auth_response = requests.post(auth_url, data=auth_data_str)\n"                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "auth_response.raise_for_status()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "token = auth_response.json()['access_token']\n"                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "Regions = ['RSE']\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |     "df = pd.DataFrame()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "userID = getpass.getuser()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "def fetch_data(Region, userID):\n"                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "    cursor = cnxn.cursor()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "    cursor.execute(f\"SELECT * FROM sta.PowerBI_Users WHERE User_ID = '{userID}' AND Region_Name = '{Region}'\")\n"                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "    row = cursor.fetchone()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "    if not row:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "        return pd.DataFrame({'Permission': ['you don’t have permission to execute the API calls']})\n"                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "    max_api_calls = row.Max_API_Calls\n"                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     "    cursor.execute(f\"SELECT * FROM sta.PowerBI_Calls WHERE User_ID = '{userID}' AND Region_Name = '{Region}' AND Call_DateTime > DATEADD(day, -1, GETDATE())\")\n"                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "    rows = cursor.fetchall()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "    if rows:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "        total_calls = sum([row.No_Of_Calls for row in rows])\n"                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "        if total_calls >= max_api_calls:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     "            return pd.DataFrame({'Permission': ['You are already exceeding your daily Calls, please try tomorrow or contact hossam.ibrahim@hlag.com']})\n"                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     "    api_url = f'https://planx.hlag.com/public/PlanX_CL_Scheme/query/testing2?year=\"2023\"&Currency=\"USD\"&Region={Region}&Layer 2=\"HL\"&CL Scheme Hierarchy=\"030\"&CL Scheme Type=\"020\"'\n"                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     "    headers = {'Authorization': f'Bearer {token}','Client-ID': 'API_User',}\n"                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "    response = requests.get(api_url, headers=headers)\n"                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     "    response.raise_for_status()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "    data = response.json()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "    temp_df = pd.DataFrame(data['data'], columns=['Month', 'Version', 'Layer Level 3','Currency', 'CL Scheme', 'Relation', 'REP CL Scheme'])\n"                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "    no_of_calls = 1\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "    if not temp_df.empty:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "        call_date = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n"                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "        cursor.execute(f\"INSERT INTO sta.PowerBI_Calls (Region_Name, User_ID, Query_url, Call_DateTime, No_Of_Calls) VALUES ('{Region}', '{userID}', '{api_url}', '{call_date}', {no_of_calls})\")\n"                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "        cnxn.commit()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     "    return temp_df\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "for Region in Regions:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     "    temp_df = fetch_data(Region, userID)\n"                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     "    if temp_df is not None:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "        df = pd.concat([df, temp_df])\n"                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     "del temp_df\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "cnxn.close()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "df"                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               | )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Escape the script for SQL insertion                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | script_sql_escaped = script.replace("'", "''")                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Now, you can store `script_sql_escaped` in your SQL table.                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | cursor.execute(f"INSERT INTO [sta].[PowerBI_Script] (ScriptID, Region_Name, Script_Data) VALUES (1, 'RSE', '{script_sql_escaped}')")                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cnxn.commit()                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | When you fetch the script from the SQL table, replace `''` back to `'`.                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | cursor.execute("SELECT Script_Data FROM [sta].[PowerBI_Script] WHERE ScriptID = 1 AND Region_Name = 'RSE'")                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | row = cursor.fetchone()                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | if row is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     python_script = row[0].replace("''", "'")                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Then, use `exec` to run the fetched script.                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | globals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | locals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | exec(python_script, globals_, locals_)  # Execute the script                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | df = locals_.get('df')  # Access 'df' from executed script                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Remember to use this method with caution as executing scripts from untrusted sources can be a security risk. Always make sure that the scripts you are executing are from a trusted source and do not contain any harmful code.                                                                                                                                                                                                                                                  |                       |                                      |
| 1144 | aaa2ea16-11d8-456c-b4bd-0e0a7e3a11bd | user          |   1.68977e+09 | i need the full code for inserting the script into SQL table , then execute the script from python return the df                                                                                                                                                                                                                                                                                                                                                                 | finished_successfully | 8859a8e8-1325-438a-bb8f-90094a3104ab |
| 1145 | a4ab6da2-3155-4de0-b5fb-e622da44f237 | assistant     |   1.68977e+09 | The full code, considering the earlier discussions, would look something like the following:                                                                                                                                                                                                                                                                                                                                                                                     | finished_successfully | aaa2ea16-11d8-456c-b4bd-0e0a7e3a11bd |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 1. Storing the script in the SQL table:                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | database = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | username = 'PowerBI_user'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | password = r'PowerBI\User@Hossam@HQ1611'                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Python script                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | script = (                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     # Your python script here, single quotes replaced with double quotes                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               | )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Escape the script for SQL insertion                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | script_sql_escaped = script.replace("'", "''")                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Insert the script into the SQL table                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cursor.execute(f"INSERT INTO [sta].[PowerBI_Script] (ScriptID, Region_Name, Script_Data) VALUES (1, 'RSE', '{script_sql_escaped}')")                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cnxn.commit()                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 2. Fetching and executing the script in Python:                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import codecs                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | database = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | username = 'PowerBI_user'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | password = r'PowerBI\User@Hossam@HQ1611'                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Get Python script from SQL table                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | cursor.execute("SELECT Script_Data FROM [sta].[PowerBI_Script] WHERE ScriptID = 1 AND Region_Name = 'RSE'")                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | row = cursor.fetchone()                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | if row is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     python_script = row[0].replace("''", "'")                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     globals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     locals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     exec(python_script, globals_, locals_)  # Execute the script                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     df = locals_.get('df')  # Access 'df' from executed script                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     print(df)                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Please be aware of the potential security risks of executing scripts from a database. Always ensure that you trust the source of the scripts and that they do not contain harmful code.                                                                                                                                                                                                                                                                                          |                       |                                      |
| 1146 | aaa241b6-20c0-47eb-a3b1-76b44fd892bb | user          |   1.68977e+09 | Cell In[20], line 66                                                                                                                                                                                                                                                                                                                                                                                                                                                             | finished_successfully | a4ab6da2-3155-4de0-b5fb-e622da44f237 |
|      |                                      |               |               |     )                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     ^                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | SyntaxError: (unicode error) 'unicodeescape' codec can't decode bytes in position 20-21: truncated \UXXXXXXXX escape                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
| 1147 | a2a4c054-9734-4c12-b023-80a7f0e3ab01 | assistant     |   1.68977e+09 | It looks like you're encountering a Unicode decoding error, which can happen if Python encounters a string containing backslashes `\`, followed by certain characters it considers special.                                                                                                                                                                                                                                                                                      | finished_successfully | aaa241b6-20c0-47eb-a3b1-76b44fd892bb |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | In Python, a backslash is used as an escape character, meaning it is used to introduce special character sequences. If you want to include an actual backslash in a string, it must be escaped by another backslash. For example, `'\\'` is a string containing a single backslash.                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | If your script includes backslashes, e.g. in Windows-style pathnames or regular expressions, you need to use a raw string (prefix the string with 'r'), or double the backslashes.                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Considering these points, here's how to store the script in the SQL table, handling the backslashes:                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | # Python script as a raw string                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | script = r"""                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | # Your python script here                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | """                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Escape the script for SQL insertion                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | script_sql_escaped = script.replace("'", "''").replace("\\", "\\\\")                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Insert the script into the SQL table                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cursor.execute(f"INSERT INTO [sta].[PowerBI_Script] (ScriptID, Region_Name, Script_Data) VALUES (1, 'RSE', '{script_sql_escaped}')")                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cnxn.commit()                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | And here's how to fetch and execute the script, handling the backslashes:                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | if row is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     python_script = row[0].replace("''", "'").replace("\\\\", "\\")                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     globals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     locals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     exec(python_script, globals_, locals_)  # Execute the script                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     df = locals_.get('df')  # Access 'df' from executed script                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     print(df)                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cn                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
| 1148 | aaa23bfa-afbc-4c6a-9139-1bdb60097acf | user          |   1.68977e+09 | Cell In[20], line 66                                                                                                                                                                                                                                                                                                                                                                                                                                                             | finished_successfully | a4ab6da2-3155-4de0-b5fb-e622da44f237 |
|      |                                      |               |               |     )                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     ^                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | SyntaxError: (unicode error) 'unicodeescape' codec can't decode bytes in position 20-21: truncated \UXXXXXXXX escape                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import codecs                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | database = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | username = 't_board_db'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | password = 'planX2018'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Python script                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | script = (                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "import requests\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "import pandas as pd\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "import pyodbc\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     "import time\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "import getpass\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     "import datetime\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "server = 'KFICWPNXDBSP01'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "database = 'PlanX'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "username = 'PowerBI_user'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "password = r'PowerBI\User@Hossam@HQ1611'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     "cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')\n"                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     "auth_url = 'https://planx.hlag.com/identity/connect/token'\n"                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "auth_data = {'client_id': 'API_User','client_secret': 'abcd','grant_type': 'client_credentials','scope': 'public-api',}\n"                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     "auth_data_str = '&'.join(f'{k}={v}' for k, v in auth_data.items())\n"                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "auth_response = requests.post(auth_url, data=auth_data_str)\n"                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "auth_response.raise_for_status()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "token = auth_response.json()['access_token']\n"                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "Regions = ['RSE']\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |     "df = pd.DataFrame()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "userID = getpass.getuser()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "def fetch_data(Region, userID):\n"                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "    cursor = cnxn.cursor()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "    cursor.execute(f\"SELECT * FROM sta.PowerBI_Users WHERE User_ID = '{userID}' AND Region_Name = '{Region}'\")\n"                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "    row = cursor.fetchone()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "    if not row:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "        return pd.DataFrame({'Permission': ['you don’t have permission to execute the API calls']})\n"                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "    max_api_calls = row.Max_API_Calls\n"                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     "    cursor.execute(f\"SELECT * FROM sta.PowerBI_Calls WHERE User_ID = '{userID}' AND Region_Name = '{Region}' AND Call_DateTime > DATEADD(day, -1, GETDATE())\")\n"                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "    rows = cursor.fetchall()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "    if rows:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "        total_calls = sum([row.No_Of_Calls for row in rows])\n"                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "        if total_calls >= max_api_calls:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     "            return pd.DataFrame({'Permission': ['You are already exceeding your daily Calls, please try tomorrow or contact hossam.ibrahim@hlag.com']})\n"                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     "    api_url = f'https://planx.hlag.com/public/PlanX_CL_Scheme/query/testing2?year=\"2023\"&Currency=\"USD\"&Region={Region}&Layer 2=\"HL\"&CL Scheme Hierarchy=\"030\"&CL Scheme Type=\"020\"'\n"                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     "    headers = {'Authorization': f'Bearer {token}','Client-ID': 'API_User',}\n"                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "    response = requests.get(api_url, headers=headers)\n"                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     "    response.raise_for_status()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "    data = response.json()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "    temp_df = pd.DataFrame(data['data'], columns=['Month', 'Version', 'Layer Level 3','Currency', 'CL Scheme', 'Relation', 'REP CL Scheme'])\n"                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "    no_of_calls = 1\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "    if not temp_df.empty:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "        call_date = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n"                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "        cursor.execute(f\"INSERT INTO sta.PowerBI_Calls (Region_Name, User_ID, Query_url, Call_DateTime, No_Of_Calls) VALUES ('{Region}', '{userID}', '{api_url}', '{call_date}', {no_of_calls})\")\n"                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "        cnxn.commit()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     "    return temp_df\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "for Region in Regions:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     "    temp_df = fetch_data(Region, userID)\n"                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     "    if temp_df is not None:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "        df = pd.concat([df, temp_df])\n"                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     "del temp_df\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "cnxn.close()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "df"                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               | )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Escape the script for SQL insertion                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | script_sql_escaped = script.replace("'", "''")                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Insert the script into the SQL table                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cursor.execute(f"INSERT INTO [sta].[PowerBI_Script] (ScriptID, Region_Name, Script_Data) VALUES (1, 'RSE', '{script_sql_escaped}')")                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cnxn.commit()                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
| 1149 | cd997f1d-b16d-4f36-809d-52d49d4dad37 | assistant     |   1.68977e+09 | Apologies for the confusion. The error occurs because the backslash in the password string `r'PowerBI\User@Hossam@HQ1611'` is being treated as the start of an escape sequence.                                                                                                                                                                                                                                                                                                  | finished_successfully | aaa23bfa-afbc-4c6a-9139-1bdb60097acf |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | You can address this by using a raw string literal (`r''`) to prevent the backslash being treated as the start of an escape sequence:                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 1. Storing the script in the SQL table:                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | database = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | username = 't_board_db'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | password = 'planX2018'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Python script                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | script = (                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     # Your python script here, single quotes replaced with double quotes                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     # Make sure to prefix the password string with 'r'                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Escape the script for SQL insertion                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | script_sql_escaped = script.replace("'", "''")                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Insert the script into the SQL table                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cursor.execute(f"INSERT INTO [sta].[PowerBI_Script] (ScriptID, Region_Name, Script_Data) VALUES (1, 'RSE', '{script_sql_escaped}')")                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cnxn.commit()                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 2. Fetching and executing the script in Python:                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import codecs                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | database = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | username = 't_board_db'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | password = 'planX2018'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Get Python script from SQL table                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | cursor.execute("SELECT Script_Data FROM [sta].[PowerBI_Script] WHERE ScriptID = 1 AND Region_Name = 'RSE'")                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | row = cursor.fetchone()                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | if row is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     python_script = row[0].replace("''", "'")                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     globals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     locals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     exec(python_script, globals_, locals_)  # Execute the script                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     df = locals_.get('df')  # Access 'df' from executed script                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     print(df)                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | As mentioned previously, please be aware of the potential security risks of executing scripts from a database. Always ensure that you trust the source of the scripts and that they do not contain harmful code.                                                                                                                                                                                                                                                                 |                       |                                      |
| 1150 | aaa22303-a957-4b2c-987d-682133b469bc | user          |   1.68977e+09 | also not corerct , please adjust the full code :                                                                                                                                                                                                                                                                                                                                                                                                                                 | finished_successfully | cd997f1d-b16d-4f36-809d-52d49d4dad37 |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import codecs                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | database = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | username = 't_board_db'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | password = 'planX2018'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Python script                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | script = (                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "import requests\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "import pandas as pd\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "import pyodbc\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     "import time\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "import getpass\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     "import datetime\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "server = 'KFICWPNXDBSP01'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "database = 'PlanX'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "username = 'PowerBI_user'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "password = 'r'PowerBI\User@Hossam@HQ1611''\n"                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')\n"                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     "auth_url = 'https://planx.hlag.com/identity/connect/token'\n"                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "auth_data = {'client_id': 'API_User','client_secret': 'abcd','grant_type': 'client_credentials','scope': 'public-api',}\n"                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     "auth_data_str = '&'.join(f'{k}={v}' for k, v in auth_data.items())\n"                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "auth_response = requests.post(auth_url, data=auth_data_str)\n"                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "auth_response.raise_for_status()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "token = auth_response.json()['access_token']\n"                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "Regions = ['RSE']\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |     "df = pd.DataFrame()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "userID = getpass.getuser()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "def fetch_data(Region, userID):\n"                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "    cursor = cnxn.cursor()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "    cursor.execute(f\"SELECT * FROM sta.PowerBI_Users WHERE User_ID = '{userID}' AND Region_Name = '{Region}'\")\n"                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "    row = cursor.fetchone()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "    if not row:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "        return pd.DataFrame({'Permission': ['you don’t have permission to execute the API calls']})\n"                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "    max_api_calls = row.Max_API_Calls\n"                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     "    cursor.execute(f\"SELECT * FROM sta.PowerBI_Calls WHERE User_ID = '{userID}' AND Region_Name = '{Region}' AND Call_DateTime > DATEADD(day, -1, GETDATE())\")\n"                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "    rows = cursor.fetchall()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "    if rows:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "        total_calls = sum([row.No_Of_Calls for row in rows])\n"                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "        if total_calls >= max_api_calls:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     "            return pd.DataFrame({'Permission': ['You are already exceeding your daily Calls, please try tomorrow or contact hossam.ibrahim@hlag.com']})\n"                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     "    api_url = f'https://planx.hlag.com/public/PlanX_CL_Scheme/query/testing2?year=\"2023\"&Currency=\"USD\"&Region={Region}&Layer 2=\"HL\"&CL Scheme Hierarchy=\"030\"&CL Scheme Type=\"020\"'\n"                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     "    headers = {'Authorization': f'Bearer {token}','Client-ID': 'API_User',}\n"                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "    response = requests.get(api_url, headers=headers)\n"                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     "    response.raise_for_status()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "    data = response.json()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "    temp_df = pd.DataFrame(data['data'], columns=['Month', 'Version', 'Layer Level 3','Currency', 'CL Scheme', 'Relation', 'REP CL Scheme'])\n"                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "    no_of_calls = 1\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "    if not temp_df.empty:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "        call_date = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n"                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "        cursor.execute(f\"INSERT INTO sta.PowerBI_Calls (Region_Name, User_ID, Query_url, Call_DateTime, No_Of_Calls) VALUES ('{Region}', '{userID}', '{api_url}', '{call_date}', {no_of_calls})\")\n"                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "        cnxn.commit()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     "    return temp_df\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "for Region in Regions:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     "    temp_df = fetch_data(Region, userID)\n"                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     "    if temp_df is not None:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "        df = pd.concat([df, temp_df])\n"                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     "del temp_df\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "cnxn.close()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "df"                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               | )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Escape the script for SQL insertion                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | script_sql_escaped = script.replace("'", "''")                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Insert the script into the SQL table                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cursor.execute(f"INSERT INTO [sta].[PowerBI_Script] (ScriptID, Region_Name, Script_Data) VALUES (1, 'RSE', '{script_sql_escaped}')")                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cnxn.commit()                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
| 1151 | 2be67693-b420-4d70-a1cf-4239a8ab6f28 | assistant     |   1.68977e+09 | I see the confusion now, my apologies for the oversight. Here's how you can correct it. When writing the password line of the script, you can escape the backslash by using double backslashes instead of a single one. Also, you need to adjust the quotation marks around the raw string literal:                                                                                                                                                                              | finished_successfully | aaa22303-a957-4b2c-987d-682133b469bc |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | "password = r'PowerBI\\User@Hossam@HQ1611'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Let's adjust your script with this correction:                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import codecs                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | database = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | username = 't_board_db'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | password = 'planX2018'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Python script                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | script = (                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "import requests\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "import pandas as pd\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "import pyodbc\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     "import time\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "import getpass\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     "import datetime\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "server = 'KFICWPNXDBSP01'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "database = 'PlanX'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "username = 'PowerBI_user'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "password = r'PowerBI\\User@Hossam@HQ1611'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')\n"                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     "auth_url = 'https://planx.hlag.com/identity/connect/token'\n"                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "auth_data = {'client_id': 'API_User','client_secret': 'abcd','grant_type': 'client_credentials','scope': 'public-api',}\n"                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     "auth_data_str = '&'.join(f'{k}={v}' for k, v in auth_data.items())\n"                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "auth_response = requests.post(auth_url, data=auth_data_str)\n"                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "auth_response.raise_for_status()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "token = auth_response.json()['access_token']\n"                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "Regions = ['RSE']\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |     "df = pd.DataFrame()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "userID = getpass.getuser()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "def fetch_data(Region, userID):\n"                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "    cursor = cnxn.cursor()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "    cursor.execute(f\"SELECT * FROM sta.PowerBI_Users WHERE User_ID = '{userID}' AND Region_Name = '{Region}'\")\n"                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "    row = cursor.fetchone()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "    if not row:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "        return pd.DataFrame({'Permission': ['you don’t have permission to execute the API calls']})\n"                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "    max_api_calls = row.Max_API_Calls\n"                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     "    cursor.execute(f\"SELECT * FROM sta.PowerBI_Calls WHERE User_ID = '{userID}' AND Region_Name = '{Region}' AND Call_DateTime > DATEADD(day, -1, GETDATE())\")\n"                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "    rows = cursor.fetchall()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "    if rows:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "        total_calls = sum([row.No_Of_Calls for row in rows])\n"                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "        if total_calls >= max_api_calls:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     "            return pd.DataFrame({'Permission': ['You are already exceeding your daily Calls, please try tomorrow or contact hossam.ibrahim@hlag.com']})\n"                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     "    api_url = f'https://planx.hlag.com/public/PlanX_CL_Scheme/query/testing2?year=\"2023\"&Currency=\"USD\"&Region={Region}&Layer 2=\"HL\"&CL Scheme Hierarchy=\"030\"&CL Scheme Type=\"020\"'\n"                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     "    headers = {'Authorization': f'Bearer {token}','Client-ID': 'API_User',}\n"                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "    response = requests.get(api_url, headers=headers)\n"                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     "    response.raise_for_status()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "    data = response.json()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "    temp_df = pd.DataFrame(data['data'], columns=['Month', 'Version', 'Layer Level 3','Currency', 'CL Scheme', 'Relation', 'REP CL Scheme'])\n"                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "    no_of_calls = 1\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "    if not temp_df.empty:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "        call_date = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n"                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "        cursor.execute(f\"INSERT INTO sta.PowerBI_Calls (Region_Name, User_ID, Query_url, Call_DateTime, No_Of_Calls) VALUES ('{Region}', '{userID}', '{api_url}', '{call_date}', {no_of_calls})\")\n"                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "        cnxn.commit()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     "    return temp_df\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "for Region in Regions:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     "    temp_df = fetch_data(Region, userID)\n"                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     "    if temp_df is not None:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "        df = pd.concat([df, temp_df])\n"                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     "del temp_df\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "cnxn.close()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "df"                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               | )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Escape the script for SQL insertion                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | script_sql_escaped = script.replace("'", "''")                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Insert the script into the SQL table                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cursor.execute(f"INSERT INTO [sta].[PowerBI_Script] (ScriptID, Region_Name, Script_Data) VALUES (1, 'RSE', '{script_sql_escaped}')")                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cnxn.commit()                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
| 1152 | aaa26f3a-f26b-4c97-bed3-600f3fdffd0c | user          |   1.68977e+09 | File :22, in fetch_data(Region, userID)                                                                                                                                                                                                                                                                                                                                                                                                                                          | finished_successfully | 2be67693-b420-4d70-a1cf-4239a8ab6f28 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | NameError: name 'cnxn' is not defined                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
| 1153 | 76b58647-8853-4ef6-82d2-975a786c3bfb | assistant     |   1.68977e+09 | I see the problem. When the Python script string is executed, it doesn't have access to the `cnxn` variable from the outer scope. You need to pass the connection to the function as an argument or create the connection inside the function.                                                                                                                                                                                                                                   | finished_successfully | aaa26f3a-f26b-4c97-bed3-600f3fdffd0c |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Here's how you can do it:                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import codecs                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | database = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | username = 't_board_db'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | password = 'planX2018'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Python script                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | script = (                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "import requests\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "import pandas as pd\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "import pyodbc\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     "import time\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "import getpass\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     "import datetime\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "server = 'KFICWPNXDBSP01'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "database = 'PlanX'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "username = 'PowerBI_user'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "password = r'PowerBI\\User@Hossam@HQ1611'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')\n"                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     "auth_url = 'https://planx.hlag.com/identity/connect/token'\n"                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "auth_data = {'client_id': 'API_User','client_secret': 'abcd','grant_type': 'client_credentials','scope': 'public-api',}\n"                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     "auth_data_str = '&'.join(f'{k}={v}' for k, v in auth_data.items())\n"                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "auth_response = requests.post(auth_url, data=auth_data_str)\n"                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "auth_response.raise_for_status()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "token = auth_response.json()['access_token']\n"                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "Regions = ['RSE']\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |     "df = pd.DataFrame()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "userID = getpass.getuser()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "def fetch_data(Region, userID, cnxn):\n"  # Add cnxn as an argument                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "    cursor = cnxn.cursor()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "    cursor.execute(f\"SELECT * FROM sta.PowerBI_Users WHERE User_ID = '{userID}' AND Region_Name = '{Region}'\")\n"                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "    row = cursor.fetchone()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "    if not row:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "        return pd.DataFrame({'Permission': ['you don’t have permission to execute the API calls']})\n"                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "    max_api_calls = row.Max_API_Calls\n"                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     "    cursor.execute(f\"SELECT * FROM sta.PowerBI_Calls WHERE User_ID = '{userID}' AND Region_Name = '{Region}' AND Call_DateTime > DATEADD(day, -1, GETDATE())\")\n"                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "    rows = cursor.fetchall()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "    if rows:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "        total_calls = sum([row.No_Of_Calls for row in rows])\n"                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "        if total_calls >= max_api_calls:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     "            return pd.DataFrame({'Permission': ['You are already exceeding your daily Calls, please try tomorrow or contact hossam.ibrahim@hlag.com']})\n"                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     "    api_url = f'https://planx.hlag.com/public/PlanX_CL_Scheme/query/testing2?year=\"2023\"&Currency=\"USD\"&Region={Region}&Layer 2=\"HL\"&CL Scheme Hierarchy=\"030\"&CL Scheme Type=\"020\"'\n"                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     "    headers = {'Authorization': f'Bearer {token}','Client-ID': 'API_User',}\n"                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "    response = requests.get(api_url, headers=headers)\n"                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     "    response.raise_for_status()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "    data = response.json()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "    temp_df = pd.DataFrame(data['data'], columns=['Month', 'Version', 'Layer Level 3','Currency', 'CL Scheme', 'Relation', 'REP CL Scheme'])\n"                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "    no_of_calls = 1\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "    if not temp_df.empty:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "        call_date = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n"                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "        cursor.execute(f\"INSERT INTO sta.PowerBI_Calls (Region_Name, User_ID, Query_url, Call_DateTime, No_Of_Calls) VALUES ('{Region}', '{userID}', '{api_url}', '{call_date}', {no_of_calls})\")\n"                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "        cnxn.commit()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     "    return temp_df\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "for Region in Regions:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     "    temp_df = fetch_data(Region, userID, cnxn)\n"  # Pass cnxn to the function                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "    if temp_df is not None:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "        df = pd.concat([df, temp_df])\n"                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     "del temp_df\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "cnxn.close()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "df"                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               | )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Escape the script for SQL insertion                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | script_sql_escaped = script.replace("'", "''")                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Insert the script into the SQL table                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cursor.execute(f"INSERT INTO [sta].[PowerBI_Script] (ScriptID, Region_Name, Script_Data) VALUES (1, 'RSE', '{script_sql_escaped}')")                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cnxn.commit()                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | This modification adds `cnxn` as an argument to `fetch_data` function and passes the connection when the function is called. Note that the connection is now established in the Python script string, so the variable `cnxn` is defined within that scope and can be passed to the function.                                                                                                                                                                                     |                       |                                      |
| 1154 | aaa2aba7-f4b2-43fe-8f6e-ebff47b28d49 | user          |   1.68977e+09 | when i execute the script through below code, it gives me error : NameError: name 'token' is not defined :                                                                                                                                                                                                                                                                                                                                                                       | finished_successfully | 76b58647-8853-4ef6-82d2-975a786c3bfb |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import codecs                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | database = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | username = 't_board_db'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | password = 'planX2018'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Get Python script from SQL table                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | cursor.execute("SELECT Script_Data FROM [sta].[PowerBI_Script] WHERE ScriptID = 1 AND Region_Name = 'RSE'")                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | row = cursor.fetchone()                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | if row is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     python_script = row[0].replace("''", "'")                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     globals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     locals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     exec(python_script, globals_, locals_)  # Execute the script                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     df = locals_.get('df')  # Access 'df' from executed script                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     print(df)                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
| 1155 | 3d0bacb8-3b61-4ff2-8c24-f136b198d5f6 | assistant     |   1.68977e+09 | The error is due to `token` not being accessible in the scope of the `fetch_data` function. Global variables in Python are available everywhere except in the local scope of functions. This is why `cnxn` was not defined earlier and now `token` is not defined. You could make `token` a parameter of the `fetch_data` function, similar to what we did with `cnxn`, but this may start to get unwieldy if you have many such variables.                                      | finished_successfully | aaa2aba7-f4b2-43fe-8f6e-ebff47b28d49 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | A better solution is to encapsulate all your code into a class or a function. This way, the variables will be accessible throughout the entire class or function, including in any inner functions. Here's a version of your script where everything is encapsulated in a main function:                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import codecs                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | database = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | username = 't_board_db'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | password = 'planX2018'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Python script                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | script = (                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "def main():\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "    import requests\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "    import pandas as pd\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     "    import pyodbc\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |     "    import time\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "    import getpass\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "    import datetime\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "    server = 'KFICWPNXDBSP01'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     "    database = 'PlanX'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     "    username = 'PowerBI_user'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     "    password = r'PowerBI\\User@Hossam@HQ1611'\n"                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     "    cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')\n"                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     "    auth_url = 'https://planx.hlag.com/identity/connect/token'\n"                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     "    auth_data = {'client_id': 'API_User','client_secret': 'abcd','grant_type': 'client_credentials','scope': 'public-api',}\n"                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "    auth_data_str = '&'.join(f'{k}={v}' for k, v in auth_data.items())\n"                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     "    auth_response = requests.post(auth_url, data=auth_data_str)\n"                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "    auth_response.raise_for_status()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     "    token = auth_response.json()['access_token']\n"                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "    Regions = ['RSE']\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     "    df = pd.DataFrame()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     "    userID = getpass.getuser()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     "    def fetch_data(Region, userID, cnxn, token):\n"  # Add token as an argument                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "        cursor = cnxn.cursor()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     "        cursor.execute(f\"SELECT * FROM sta.PowerBI_Users WHERE User_ID = '{userID}' AND Region_Name = '{Region}'\")\n"                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     "        row = cursor.fetchone()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "        if not row:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "            return pd.DataFrame({'Permission': ['you don’t have permission to execute the API calls']})\n"                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     "        max_api_calls = row.Max_API_Calls\n"                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "        cursor.execute(f\"SELECT * FROM sta.PowerBI_Calls WHERE User_ID = '{userID}' AND Region_Name = '{Region}' AND Call_DateTime > DATEADD(day, -1, GETDATE())\")\n"                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     "        rows = cursor.fetchall()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "        if rows:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "            total_calls = sum([row.No_Of_Calls for row in rows])\n"                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "            if total_calls >= max_api_calls:\n"                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "                return pd.DataFrame({'Permission': ['You are already exceeding your daily Calls, please try tomorrow or contact hossam.ibrahim@hlag.com']})\n"                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "        api_url = f'https://planx.hlag.com/public/PlanX_CL_Scheme/query/testing2?year=\"2023\"&Currency=\"USD\"&Region={Region}&Layer 2=\"HL\"&CL Scheme Hierarchy=\"030\"&CL Scheme Type=\"020\"'\n"                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "        headers = {'Authorization': f'Bearer {token}','Client-ID': 'API_User',}\n"                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "        response = requests.get(api_url, headers=headers)\n"                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "        response.raise_for_status()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "        data = response.json()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     "        temp_df = pd.DataFrame(data['data'], columns=['Month', 'Version', 'Layer Level 3','Currency', 'CL Scheme', 'Relation', 'REP CL Scheme'])\n"                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "        no_of_calls = 1\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     "        if not temp_df.empty:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     "            call_date = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n"                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     "            cursor.execute(f\"INSERT INTO sta.PowerBI_Calls (Region_Name, User_ID, Query_url, Call_DateTime, No_Of_Calls) VALUES ('{Region}', '{userID}', '{api_url}', '{call_date}', {no_of_calls})\")\n"                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     "            cnxn.commit()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "        return temp_df\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     "    for Region in Regions:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "        temp_df = fetch_data(Region, userID, cnxn, token)\n"  # Pass token to the function                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     "        if temp_df is not None:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "            df = pd.concat([df, temp_df])\n"                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "    del temp_df\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "    cnxn.close()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "    return df\n"  # Return 'df' from main function                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "main()\n"  # Call the main function                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               | )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Escape the script for SQL insertion                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | script_sql_escaped = script.replace("'", "''")                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Insert the script into the SQL table                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cursor.execute(f"INSERT INTO [sta].[PowerBI_Script] (ScriptID, Region_Name, Script_Data) VALUES (1, 'RSE', '{script_sql_escaped}')")                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cnxn.commit()                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Then, when you execute the script, you can directly get `df` from the execution context, like this:                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import codecs                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | database = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | username = 't_board_db'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | password = 'planX2018'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
| 1156 | aaa248f3-52d9-419c-a10a-3a1c732d035c | user          |   1.68977e+09 | based on above , after i run the below script, i am geeting empty df and suppose to have the df that has been executed from the api calls :                                                                                                                                                                                                                                                                                                                                      | finished_successfully | 3d0bacb8-3b61-4ff2-8c24-f136b198d5f6 |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import codecs                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | database = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | username = 't_board_db'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | password = 'planX2018'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Get Python script from SQL table                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | cursor.execute("SELECT Script_Data FROM [sta].[PowerBI_Script] WHERE ScriptID = 1 AND Region_Name = 'RSE'")                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | row = cursor.fetchone()                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | if row is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     python_script = row[0].replace("''", "'")                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     globals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     locals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     exec(python_script, globals_, locals_)  # Execute the script                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     df = locals_.get('df')  # Access 'df' from executed script                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     df                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
| 1157 | de6e622a-45c6-4683-92ba-b40b114a2744 | assistant     |   1.68977e+09 | The reason you're getting an empty DataFrame is because the `exec` function does not automatically return the last value in the script. When you use the `exec` function to execute a script, it doesn't automatically return the value of the last expression like how a Jupyter notebook cell or a Python interactive shell would.                                                                                                                                             | finished_successfully | aaa248f3-52d9-419c-a10a-3a1c732d035c |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | You need to modify the script to return the DataFrame (`df`). Since you've encapsulated everything in a `main` function, you can have that function return `df`, and then store the return value in a variable when calling `main`.                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Here's how to modify your script:                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | # Get Python script from SQL table                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | cursor.execute("SELECT Script_Data FROM [sta].[PowerBI_Script] WHERE ScriptID = 1 AND Region_Name = 'RSE'")                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | row = cursor.fetchone()                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | if row is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     python_script = row[0].replace("''", "'")                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     globals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     locals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     exec(python_script, globals_, locals_)  # Execute the script                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     df = locals_['main']()  # Call 'main' function and get 'df'                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     print(df)                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | In this version, after the script is executed with `exec`, the `main` function is accessible as `locals_['main']`. Calling this function with `locals_['main']()` executes the function and returns `df`, which you then store in the `df` variable and print.                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Please let me know if this helps.                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
| 1158 | aaa26910-9db7-4f3b-8395-0bd71b17a372 | user          |   1.68977e+09 | ok, everything works fine now and i have the datafame, but only one thing went wrong, fisrt it takes long time to execute like a double of the time and second it's recorded two calls in table sta.PowerBI_Calls, it means the script executed two times to get the result if i understand correctly                                                                                                                                                                            | finished_successfully | de6e622a-45c6-4683-92ba-b40b114a2744 |
| 1159 | fb20becd-eae6-46e0-adec-9d21e309908b | assistant     |   1.68977e+09 | It's a bit challenging to troubleshoot exactly why your script is taking a long time to execute or why it is executing twice without more information. However, here are a couple of possible reasons and solutions:                                                                                                                                                                                                                                                             | finished_successfully | aaa26910-9db7-4f3b-8395-0bd71b17a372 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 1. **Nested Function Calls:** If you have nested function calls or loops in your script, that could be causing it to take a long time to execute. You should review your script to see if there's a way to streamline the flow of execution.                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 2. **Repeated Connections:** If you're opening and closing the database connection for each API call, this could also cause the execution to be slow. It might be more efficient to open the connection once at the start of the script, and close it once at the end.                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 3. **The Script is Executed Twice:** As for why your script is being executed twice, it's possible that there's an issue with how you're calling the `main` function. If you are calling `locals_['main']()` twice in your code, then it would indeed execute the script twice.                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | You could place a print statement at the beginning of the `main` function to check how many times it's being called:                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | def main():                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     print("Main function called")                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     # Rest of your code                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Check to see if "Main function called" is printed twice when you execute the script.                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Without a closer look at your script and execution process, it's hard to provide a more specific answer. If these suggestions don't help, you may need to debug your script to pinpoint the cause of the problem.                                                                                                                                                                                                                                                                |                       |                                      |
| 1160 | aaa26324-5d34-4f00-bd3a-d6b106ac0d1f | user          |   1.68977e+09 | i think the problem in below code you provided before , coudl you please review the full code :                                                                                                                                                                                                                                                                                                                                                                                  | finished_successfully | fb20becd-eae6-46e0-adec-9d21e309908b |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import codecs                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | database = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | username = 't_board_db'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | password = 'planX2018'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Python script                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | script = (                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "def main():\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "    import requests\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "    import pandas as pd\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     "    import pyodbc\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |     "    import time\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "    import getpass\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "    import datetime\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "    server = 'KFICWPNXDBSP01'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     "    database = 'PlanX'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     "    username = 'PowerBI_user'\n"                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     "    password = r'PowerBI\\User@Hossam@HQ1611'\n"                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     "    cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')\n"                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     "    auth_url = 'https://planx.hlag.com/identity/connect/token'\n"                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     "    auth_data = {'client_id': 'API_User','client_secret': 'abcd','grant_type': 'client_credentials','scope': 'public-api',}\n"                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "    auth_data_str = '&'.join(f'{k}={v}' for k, v in auth_data.items())\n"                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     "    auth_response = requests.post(auth_url, data=auth_data_str)\n"                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "    auth_response.raise_for_status()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     "    token = auth_response.json()['access_token']\n"                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "    Regions = ['RSE']\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     "    df = pd.DataFrame()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     "    userID = getpass.getuser()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     "    def fetch_data(Region, userID, cnxn, token):\n"  # Add token as an argument                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "        cursor = cnxn.cursor()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     "        cursor.execute(f\"SELECT * FROM sta.PowerBI_Users WHERE User_ID = '{userID}' AND Region_Name = '{Region}'\")\n"                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     "        row = cursor.fetchone()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "        if not row:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "            return pd.DataFrame({'Permission': ['you don’t have permission to execute the API calls']})\n"                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     "        max_api_calls = row.Max_API_Calls\n"                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "        cursor.execute(f\"SELECT * FROM sta.PowerBI_Calls WHERE User_ID = '{userID}' AND Region_Name = '{Region}' AND Call_DateTime > DATEADD(day, -1, GETDATE())\")\n"                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     "        rows = cursor.fetchall()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "        if rows:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "            total_calls = sum([row.No_Of_Calls for row in rows])\n"                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "            if total_calls >= max_api_calls:\n"                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     "                return pd.DataFrame({'Permission': ['You are already exceeding your daily Calls, please try tomorrow or contact hossam.ibrahim@hlag.com']})\n"                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "        api_url = f'https://planx.hlag.com/public/PlanX_CL_Scheme/query/testing2?year=\"2023\"&Currency=\"USD\"&Region={Region}&Layer 2=\"HL\"&CL Scheme Hierarchy=\"030\"&CL Scheme Type=\"020\"'\n"                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "        headers = {'Authorization': f'Bearer {token}','Client-ID': 'API_User',}\n"                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "        response = requests.get(api_url, headers=headers)\n"                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "        response.raise_for_status()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     "        data = response.json()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     "        temp_df = pd.DataFrame(data['data'], columns=['Month', 'Version', 'Layer Level 3','Currency', 'CL Scheme', 'Relation', 'REP CL Scheme'])\n"                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "        no_of_calls = 1\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     "        if not temp_df.empty:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     "            call_date = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')\n"                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     "            cursor.execute(f\"INSERT INTO sta.PowerBI_Calls (Region_Name, User_ID, Query_url, Call_DateTime, No_Of_Calls) VALUES ('{Region}', '{userID}', '{api_url}', '{call_date}', {no_of_calls})\")\n"                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     "            cnxn.commit()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "        return temp_df\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     "    for Region in Regions:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     "        temp_df = fetch_data(Region, userID, cnxn, token)\n"  # Pass token to the function                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     "        if temp_df is not None:\n"                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "            df = pd.concat([df, temp_df])\n"                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     "    del temp_df\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "    cnxn.close()\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     "    return df\n"  # Return 'df' from main function                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     "main()\n"  # Call the main function                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               | )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Escape the script for SQL insertion                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | script_sql_escaped = script.replace("'", "''")                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Insert the script into the SQL table                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cursor.execute(f"INSERT INTO [sta].[PowerBI_Script] (ScriptID, Region_Name, Script_Data) VALUES (1, 'RSE', '{script_sql_escaped}')")                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cnxn.commit()                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
| 1161 | 2fb402f0-fea9-42ef-a85a-5edd56061f99 | assistant     |   1.68977e+09 | It seems you're storing the Python script in a SQL table, then fetching it, executing it, and then storing the resulting dataframe.                                                                                                                                                                                                                                                                                                                                              | finished_successfully | aaa26324-5d34-4f00-bd3a-d6b106ac0d1f |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | The issue that you're describing might be due to the fact that at the end of the Python script you have `main()` which calls the main function right after it's defined. Then, when you fetch and execute the script, the main function runs again because of `exec(python_script, globals_, locals_)`.                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Here's a possible solution: remove the `main()` at the end of the script that's being stored in the SQL table, and only call it when executing the script after fetching:                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import codecs                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | database = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | username = 't_board_db'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | password = 'planX2018'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Python script                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | script = (                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "def main():\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "    import requests\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     #... Rest of your script                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     "    return df\n"  # Return 'df' from main function                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Escape the script for SQL insertion                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | script_sql_escaped = script.replace("'", "''")                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Insert the script into the SQL table                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cursor.execute(f"INSERT INTO [sta].[PowerBI_Script] (ScriptID, Region_Name, Script_Data) VALUES (1, 'RSE', '{script_sql_escaped}')")                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cnxn.commit()                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Fetch the script                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | cursor.execute("SELECT Script_Data FROM [sta].[PowerBI_Script] WHERE ScriptID = 1 AND Region_Name = 'RSE'")                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | row = cursor.fetchone()                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | if row is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     python_script = row[0].replace("''", "'")                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     globals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     locals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     exec(python_script, globals_, locals_)  # Execute the script                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     df = locals_['main']()  # Call the main function and store the result in 'df'                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     print(df)                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | In this version, `main()` is only called once, when you execute the script after fetching it. This should prevent your script from executing twice and may also help to decrease the execution time. If you're still encountering performance issues, it might be necessary to optimize your script or look into methods of parallelizing your data fetching process, if possible.                                                                                               |                       |                                      |
| 1162 | aaa27f27-2cfd-46be-8e55-0e0ab79af5ca | user          |   1.68977e+09 | but this si the same i have  as below , so please review below and above code and investiagte and correct the issue for why is calling tow times API and record two entry in table :sta.PowerBI_Calls                                                                                                                                                                                                                                                                            | finished_successfully | 2fb402f0-fea9-42ef-a85a-5edd56061f99 |
|      |                                      |               |               | please adjust and write the full code :                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import codecs                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | database = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | username = 't_board_db'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | password = 'planX2018'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cursor.execute("SELECT Script_Data FROM [sta].[PowerBI_Script] WHERE ScriptID = 1 AND Region_Name = 'RSE'")                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | row = cursor.fetchone()                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | if row is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     python_script = row[0].replace("''", "'")                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     globals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     locals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     exec(python_script, globals_, locals_)  # Execute the script                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     df = locals_['main']()  # Call 'main' function and get 'df'                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     df                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
| 1163 | 9dcfaa87-5c44-4d52-9c95-121ab73a717a | assistant     |   1.68977e+09 | The issue may stem from your script definition which is stored in the SQL table. When you store your script, does it end with `main()`? If it does, that might be the cause of the issue, as this would call the function once when the script is loaded and again when you call `main()` explicitly.                                                                                                                                                                            | finished_successfully | aaa27f27-2cfd-46be-8e55-0e0ab79af5ca |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | We need to ensure that your stored script doesn't contain the `main()` call at the end.                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Let's rewrite the script storing part as below:                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import codecs                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | database = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | username = 't_board_db'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | password = 'planX2018'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Python script                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | script = (                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     "def main():\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     "    import requests\n"                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     #... Rest of your script                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     "    return df\n"  # Return 'df' from main function                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Escape the script for SQL insertion                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | script_sql_escaped = script.replace("'", "''")                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Insert the script into the SQL table                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cursor.execute(f"INSERT INTO [sta].[PowerBI_Script] (ScriptID, Region_Name, Script_Data) VALUES (1, 'RSE', '{script_sql_escaped}')")                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cnxn.commit()                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Then, we fetch the script and execute it as below:                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import codecs                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | server = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | database = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | username = 't_board_db'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | password = 'planX2018'                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(f'DRIVER={{ODBC Driver 17 for SQL Server}};SERVER={server};DATABASE={database};UID={username};PWD={password}')                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Fetch the script                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | cursor.execute("SELECT Script_Data FROM [sta].[PowerBI_Script] WHERE ScriptID = 1 AND Region_Name = 'RSE'")                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | row = cursor.fetchone()                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | if row is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     python_script = row[0].replace("''", "'")                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     globals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     locals_ = {}                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     exec(python_script, globals_, locals_)  # Execute the script                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     df = locals_['main']()  # Call 'main' function and get 'df'                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     print(df) # or just df in Jupyter notebooks                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | This approach will ensure that `main()` function gets called only once when you execute the fetched script. If you're still getting double entries in your `sta.PowerBI_Calls` table, then the issue might be somewhere else in your script, and we'll need to debug it further.                                                                                                                                                                                                 |                       |                                      |
| 1164 | aaa2a54a-172d-42fb-a7b9-450752e169c7 | user          |   1.68978e+09 | it works perfect .. Thanks                                                                                                                                                                                                                                                                                                                                                                                                                                                       | finished_successfully | 9dcfaa87-5c44-4d52-9c95-121ab73a717a |
| 1165 | ff8f02d3-c4fb-4cd7-ab6a-d5a660e4680f | assistant     |   1.68978e+09 | You're welcome! I'm glad to hear that it's working perfectly now. If you have any more questions or run into any more issues, don't hesitate to ask. Happy coding!                                                                                                                                                                                                                                                                                                               | finished_successfully | aaa2a54a-172d-42fb-a7b9-450752e169c7 |
| 1166 | d1d9d90e-8f81-4efd-9d39-3155a17009bb | system        |   1.68975e+09 |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | finished_successfully | aaa1cd25-eb63-46d6-9c34-659ac6d68210 |
| 1167 | aaa204a7-f926-409a-b5a1-28f2f73239d7 | user          |   1.68975e+09 | i have database in MS SQL Server named PlanX , i need to create a user account with password , and this user can done below :                                                                                                                                                                                                                                                                                                                                                    | finished_successfully | d1d9d90e-8f81-4efd-9d39-3155a17009bb |
|      |                                      |               |               | 1. cannot access SQL server.                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | 2. the user can be read only                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | 3. the user only can query two specific table named (table_named and table_max)                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 4. user cannot preform any action and only read and write on the two specific table mentioned in no 3                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
| 1168 | f0ad762b-2414-44e8-8bcd-6d89d3557e62 | assistant     |   1.68975e+09 | Creating a new user in SQL Server that has specific permissions to two tables can be achieved by following these steps:                                                                                                                                                                                                                                                                                                                                                          | finished_successfully | aaa204a7-f926-409a-b5a1-28f2f73239d7 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 1. First, connect to the SQL Server Database.                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | 2. Open a new query window.                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | 3. Next, you need to create a login for SQL Server. Let's say the login name is `NewUser` and password is `NewUserPassword`.                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | CREATE LOGIN NewUser WITH PASSWORD = 'NewUserPassword';                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 4. Now, let's use your specific database, `PlanX`, and create a user for the login you just created.                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | USE PlanX;                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | GO                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | CREATE USER NewUser FOR LOGIN NewUser;                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 5. By default, the user will not have any permissions. So, next we will grant SELECT permissions to `NewUser` for the two specific tables (`table_named` and `table_max`).                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | GRANT SELECT ON table_named TO NewUser;                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | GRANT SELECT ON table_max TO NewUser;                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Please note that, since the user does not have the CONNECT SQL privilege, the user cannot connect to the SQL Server Database Engine. Also, because the user only has SELECT permission on the two specified tables, they cannot perform any action on the database other than reading those two tables.                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | The user will not have write permissions on the two tables, since you granted only the SELECT permission. If you need the user to be able to write (insert, update, delete) on the two tables, you can also grant those permissions as needed:                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | GRANT INSERT, UPDATE, DELETE ON table_named TO NewUser;                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | GRANT INSERT, UPDATE, DELETE ON table_max TO NewUser;                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | You should replace `'NewUserPassword'`, `NewUser`, `table_named`, and `table_max` with the actual password, user name, and table names that you plan to use.                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Please also be aware that this answer assumes you are a system administrator (SA) or equivalent on the SQL Server instance, as the SA role would be required to execute these commands.                                                                                                                                                                                                                                                                                          |                       |                                      |
| 1169 | aaa298d7-58fa-42a8-956a-69294d7a44a3 | user          |   1.68975e+09 | how i can get the windows userid from python                                                                                                                                                                                                                                                                                                                                                                                                                                     | finished_successfully | f0ad762b-2414-44e8-8bcd-6d89d3557e62 |
| 1170 | 4436a733-deff-4f80-abe5-28f9bb391254 | assistant     |   1.68975e+09 | You can retrieve the current Windows user ID in Python using the `getpass` module. The `getpass.getuser()` function returns the login name of the user.                                                                                                                                                                                                                                                                                                                          | finished_successfully | aaa298d7-58fa-42a8-956a-69294d7a44a3 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Here's a simple example:                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import getpass                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | user = getpass.getuser()                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | print("Current Windows user:", user)                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | When you run this script, it will print the current Windows user.                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | This works on most platforms, not just Windows. The `getpass` module uses various methods to determine the current user and should work in most environments. However, keep in mind that the returned user name may not always be what you expect, especially in complex environments or when your Python script is run from certain system accounts or services. Always test to be sure.                                                                                        |                       |                                      |
| 1171 | aaa24067-014d-47b0-87f9-92fc259f6868 | user          |   1.68975e+09 | please convert that to dataframe with column named userID                                                                                                                                                                                                                                                                                                                                                                                                                        | finished_successfully | 4436a733-deff-4f80-abe5-28f9bb391254 |
| 1172 | da713db6-b897-411a-a3f2-e6ca5e685585 | assistant     |   1.68975e+09 | Sure, you can convert the Windows username to a pandas DataFrame. First, you'll need to make sure you have pandas installed. If not, you can install it via pip:                                                                                                                                                                                                                                                                                                                 | finished_successfully | aaa24067-014d-47b0-87f9-92fc259f6868 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```sh                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | pip install pandas                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Here's how you could create a DataFrame with a single row and column, where the column is named 'userID' and the row contains the Windows username:                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import getpass                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | import pandas as pd                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Get the current Windows user                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | user = getpass.getuser()                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Create a DataFrame                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | df = pd.DataFrame([user], columns=['userID'])                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | print(df)                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | This will create a DataFrame that looks something like this:                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |   userID                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               | 0  User_Name                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Please replace `User_Name` with your actual Windows username. This DataFrame has a single row with the index 0, and a single column named 'userID'.                                                                                                                                                                                                                                                                                                                              |                       |                                      |
| 1173 | aaa280de-7b63-4268-90c2-c5894c0dd6a7 | user          |   1.68975e+09 | i want to create a table in SQL in database named PlanX , the table name will be PowerBI_Users, and tbale contains below column with exmaple :                                                                                                                                                                                                                                                                                                                                   | finished_successfully | da713db6-b897-411a-a3f2-e6ca5e685585 |
|      |                                      |               |               | 1. Region : RSE                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 2. User_Name : IBRAHHO                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | 3. Creation_Date : today date                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | 4. Max_calls : 30                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
| 1174 | dc4b9f79-fb23-4d5b-bfa1-236e983ac910 | assistant     |   1.68975e+09 | You can create a table in SQL Server with the required fields using the following SQL query:                                                                                                                                                                                                                                                                                                                                                                                     | finished_successfully | aaa280de-7b63-4268-90c2-c5894c0dd6a7 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | USE PlanX;                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | GO                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | CREATE TABLE PowerBI_Users                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     Region NVARCHAR(50),                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     User_Name NVARCHAR(50),                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     Creation_Date DATE,                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     Max_Calls INT                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | );                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | This will create a table named `PowerBI_Users` in the `PlanX` database. The `Region` and `User_Name` fields will be strings (with a maximum length of 50), `Creation_Date` will be a date, and `Max_Calls` will be an integer.                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Now, let's add the sample data you mentioned:                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | INSERT INTO PowerBI_Users (Region, User_Name, Creation_Date, Max_Calls)                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | VALUES ('RSE', 'IBRAHHO', GETDATE(), 30);                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | This will insert one row into the `PowerBI_Users` table with the specified values. `GETDATE()` function is used to insert the current date.                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | You can run these queries using SQL Server Management Studio or another SQL Server client. Please replace `'RSE'`, `'IBRAHHO'`, and `30` with the actual values you want to use.                                                                                                                                                                                                                                                                                                 |                       |                                      |
| 1175 | aaa291a5-faf9-4b97-9e8c-6431d9dd7992 | user          |   1.68975e+09 | i need to adjust below to execurte query and add into dataframe :                                                                                                                                                                                                                                                                                                                                                                                                                | finished_successfully | dc4b9f79-fb23-4d5b-bfa1-236e983ac910 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import pandas as pd                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | from datetime import datetime                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import time                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Define the connection details                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | server_name = 'xxx'                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | database_name = 'xxx'                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | username = 'xxx'                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | password = 'xxx'                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | connection_string = f'DRIVER={{SQL Server}};SERVER={server_name};DATABASE={database_name};UID={username};PWD={password};'                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
| 1176 | 1f631cbb-28c9-4a2b-8478-385927eeace6 | assistant     |   1.68975e+09 | You can execute an SQL query using a `pyodbc` connection and load the result into a pandas DataFrame. Here's an example of how to do this:                                                                                                                                                                                                                                                                                                                                       | finished_successfully | aaa291a5-faf9-4b97-9e8c-6431d9dd7992 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import pandas as pd                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | from datetime import datetime                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import time                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Define the connection details                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | server_name = 'xxx'                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | database_name = 'xxx'                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | username = 'xxx'                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | password = 'xxx'                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Define your SQL query                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | sql_query = "SELECT * FROM PowerBI_Users"                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Create connection string                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | connection_string = f'DRIVER={{SQL Server}};SERVER={server_name};DATABASE={database_name};UID={username};PWD={password};'                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Create connection                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(connection_string)                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Execute the query and store the result in a DataFrame                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | df = pd.read_sql(sql_query, cnxn)                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Close the connection                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Print the DataFrame                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | print(df)                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | This script will connect to your SQL Server database using the provided connection details, execute the SQL query `SELECT * FROM PowerBI_Users`, and load the result into a pandas DataFrame. The DataFrame is then printed to the console.                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Please replace `'xxx'` with your actual server name, database name, username, and password. Also, replace `SELECT * FROM PowerBI_Users` with the actual SQL query you want to execute. Make sure that your query doesn't update or delete data if you only want to read data into the DataFrame.                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | You'll need to have the `pyodbc` and `pandas` Python packages installed to run this script. If you haven't installed these packages yet, you can do so using pip:                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```sh                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | pip install pyodbc pandas                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
| 1177 | aaa2d2c7-a7a1-4e54-ae79-cc6545d9c580 | user          |   1.68976e+09 | regarding above created user having access into spesfic table only, i created a user and i grant the access but when i execute the query on the spesfic table i got error :                                                                                                                                                                                                                                                                                                      | finished_successfully | 1f631cbb-28c9-4a2b-8478-385927eeace6 |
|      |                                      |               |               |   Cell In[9], line 10                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     password = 'PowerBI\User@Hossam@HQ1611'                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                            ^                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | SyntaxError: (unicode error) 'unicodeescape' codec can't decode bytes in position 7-8: truncated \UXXXXXXXX escape                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import pandas as pd                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | from datetime import datetime                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import time                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Define the connection details                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | server_name = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | database_name = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | username = 'PowerBI_user'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | password = 'PowerBI\User@Hossam@HQ1611'                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Define your SQL query                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | sql_query = "SELECT * FROM [sta].[PowerBI_Users]"                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | #sql_query = """                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | #SELECT TOP (1000) [CODE_CL_Scheme]                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |  #     ,[DESC_CL_Scheme]                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |  # FROM [PlanX].[sta].[T_DIM_CL_Scheme] """                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | connection_string = f'DRIVER={{SQL Server}};SERVER={server_name};DATABASE={database_name};UID={username};PWD={password};'                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | # Create connection                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(connection_string)                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Execute the query and store the result in a DataFrame                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | df = pd.read_sql(sql_query, cnxn)                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Close the connection                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Print the DataFrame                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | df                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
| 1178 | 82e281e0-9294-430a-902f-dc52526a3f8b | assistant     |   1.68976e+09 | The error is happening because the backslash character `\` in your password is being interpreted as the start of an escape sequence. `\U` in a Python string is interpreted as the start of a Unicode escape sequence, which is not what you want here.                                                                                                                                                                                                                          | finished_successfully | aaa2d2c7-a7a1-4e54-ae79-cc6545d9c580 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | To fix the issue, you have two options:                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 1. You can escape the backslash by using two backslashes `\\`:                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | password = 'PowerBI\\User@Hossam@HQ1611'                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 2. Or you can use a raw string, where backslashes are treated as literal characters. You create a raw string by prefixing the string with an `r`:                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | password = r'PowerBI\User@Hossam@HQ1611'                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Here's how your corrected code would look using a raw string:                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import pandas as pd                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | from datetime import datetime                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import time                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Define the connection details                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | server_name = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | database_name = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | username = 'PowerBI_user'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | password = r'PowerBI\User@Hossam@HQ1611'                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Define your SQL query                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | sql_query = "SELECT * FROM [sta].[PowerBI_Users]"                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | connection_string = f'DRIVER={{SQL Server}};SERVER={server_name};DATABASE={database_name};UID={username};PWD={password};'                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Create connection                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | cnxn = pyodbc.connect(connection_string)                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Execute the query and store the result in a DataFrame                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | df = pd.read_sql(sql_query, cnxn)                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Close the connection                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | cnxn.close()                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Print the DataFrame                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | print(df)                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | This should now correctly use your password when connecting to your SQL Server database.                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
| 1179 | aaa2069e-6cc6-417f-9e0e-253e7d8a0567 | user          |   1.68976e+09 | i grant access to that spesfic table for insert and select only but still user can access the MS SQL using the username and password and also still user can delete data or drop the table                                                                                                                                                                                                                                                                                       | finished_successfully | 82e281e0-9294-430a-902f-dc52526a3f8b |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | GRANT INSERT ON [sta].[PowerBI_Calls] TO PowerBI_user;                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
| 1180 | 7405e1d6-8bd0-49e9-9289-7cb9661e7c9d | assistant     |   1.68976e+09 | The command you have used:                                                                                                                                                                                                                                                                                                                                                                                                                                                       | finished_successfully | aaa2069e-6cc6-417f-9e0e-253e7d8a0567 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | GRANT INSERT ON [sta].[PowerBI_Calls] TO PowerBI_user;                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | This only grants the INSERT permission to the `PowerBI_user`. This doesn't restrict the user from using other permissions that they might already have. If the user still can delete data or drop the table, that means the user has been granted more permissions than you want them to have.                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | In order to restrict the user to just `INSERT` and `SELECT` permissions on that specific table, you have to:                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 1. Revoke all permissions from the user for the table.                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | 2. Then grant the `INSERT` and `SELECT` permissions only.                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Here's how you can do this:                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | -- Revoke all permissions from the user for the specific table                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | REVOKE ALL ON [sta].[PowerBI_Calls] FROM PowerBI_user;                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | -- Grant only INSERT and SELECT permissions to the user for the specific table                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | GRANT INSERT, SELECT ON [sta].[PowerBI_Calls] TO PowerBI_user;                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | These commands first revoke all permissions that `PowerBI_user` has on the `[sta].[PowerBI_Calls]` table, and then grant the `INSERT` and `SELECT` permissions.                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Regarding your comment about the user being able to access SQL Server, a user needs to be able to connect to SQL Server in order to perform any actions, including `INSERT` and `SELECT` operations. If you don't want a user to be able to connect to SQL Server at all, you would have to revoke their `CONNECT SQL` privilege, but this would also prevent them from doing any work on the server, including the `INSERT` and `SELECT` operations you want to allow.          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | In case you wish to prevent users from connecting via a specific application like SQL Server Management Studio, you would have to implement this at the application level and not in SQL Server itself.                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Also note that `DROP TABLE` is a permission that belongs to the `db_ddladmin` role. Make sure `PowerBI_user` is not part of this role or any other role that has more permissions than you want them to have. You may also want to ensure the user is not the owner of the table or database, as owners have all permissions.                                                                                                                                                    |                       |                                      |
| 1181 | aaa2ad8e-8492-4acd-8fb1-dc3a154d98fd | user          |   1.68976e+09 | how i can do that :                                                                                                                                                                                                                                                                                                                                                                                                                                                              | finished_successfully | 7405e1d6-8bd0-49e9-9289-7cb9661e7c9d |
|      |                                      |               |               | Also note that DROP TABLE is a permission that belongs to the db_ddladmin role. Make sure PowerBI_user is not part of this role or any other role that has more permissions than you want them to have. You may also want to ensure the user is not the owner of the table or database, as owners have all permissions.                                                                                                                                                          |                       |                                      |
| 1182 | 3ec4b766-2cb9-4672-a353-f148d82feaae | assistant     |   1.68976e+09 | To check if a user is part of a specific role in SQL Server, you can use the `IS_MEMBER` function. It checks whether the current user is a member of the specified Microsoft Windows group or SQL Server database role.                                                                                                                                                                                                                                                          | finished_successfully | aaa2ad8e-8492-4acd-8fb1-dc3a154d98fd |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | -- replace PowerBI_user with the user you want to check                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | SELECT IS_MEMBER('db_ddladmin') AS IsUserInRole;                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | If the `IsUserInRole` value returned is `1`, the user is part of the `db_ddladmin` role. If it's `0`, the user is not part of the role.                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | To remove the user from the role, you can use the `sp_droprolemember` stored procedure:                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | -- replace PowerBI_user with the user you want to remove from the role                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | EXEC sp_droprolemember 'db_ddladmin', 'PowerBI_user';                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | This removes `PowerBI_user` from the `db_ddladmin` role.                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Please note that to execute the above command, you need to have the `ALTER ROLE` permission on the role (except for roles that are owned by the user) or be a member of the `db_securityadmin` fixed database role.                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | To check if a user is the owner of a database, you can use this SQL command:                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | -- replace database_name with the name of your database                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | SELECT name AS DatabaseName, SUSER_SNAME(owner_sid) AS DatabaseOwner                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | FROM sys.databases WHERE name = 'database_name';                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | If `PowerBI_user` is the owner, you might want to change the owner to a more appropriate account. You can do this with the `ALTER AUTHORIZATION` command:                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               | -- replace database_name and new_owner with the name of your database and the new owner's name                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | ALTER AUTHORIZATION ON DATABASE::database_name TO new_owner;                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | This will change the owner of the database to `new_owner`.                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Please replace `'PowerBI_user'`, `'db_ddladmin'`, `'database_name'` and `'new_owner'` with your actual user name, role name, database name, and the new owner's name respectively.                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | And as always, these operations should be performed by a user with the necessary administrative privileges.                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
| 1183 | aaa2315c-028b-4fd3-845c-ea010cfb1c6b | user          |   1.68976e+09 | Based on all created above, now I need to adjust the following python API script following below instructions :                                                                                                                                                                                                                                                                                                                                                                  | finished_successfully | 3ec4b766-2cb9-4672-a353-f148d82feaae |
|      |                                      |               |               | 1.	We created an SQL table sta.PowerBI_Users contains below with example :                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | a.	Region_Name : RSE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | b.	User_ID : IBRAHHO                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | c.	Creation_Date : 19-07-2023                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | d.	Max_API_Calls : 30                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 2.	We created another Table in MS SQL named : [sta].[PowerBI_Calls], below is example :                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | a.	Region_Name : RSE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | b.	User_ID : IBRAHHO                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | c.	Query_ur : https://planx.hlag.com/public/PlanX_CL_Scheme/query/testing2?                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | d.	Call_DateTime : 2023-07-19 00:00:00.000                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | e.	No_Of_Calls : 3                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | 3.	When we run the below python API we need to preform below actions :                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | a.	First make sure by selecting the Region_Name and User_ID from table : [sta].[PowerBI_Calls] that total No_Of_Calls during 24 hours not exceeding the Max_API_Calls from the first table by same Region_Name and User_ID and if exceudded we need to print Dataframe with column named permission and row : you are excceding today no of calls                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | b.	If the total No_Of_Calls from table  [sta].[PowerBI_Calls] still not reached the Max_API_Calls from first table : sta.PowerBI_Users then we can run the API python script and record below information in table  [sta].[PowerBI_Calls] :                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | i.	Region_Name : “RSE”                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ii.	User_ID : Windows User ID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | iii.	Query_url : api_url                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | iv.	Call_DateTime : date and time of the API python calls                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | v.	No_Of_Calls : count the number of the calls of the API python Calls                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Below is the python code that need to be adjusted and please write the full code having above instruimport requests                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | import pandas as pd                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | import time                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | auth_url = 'https://planx.hlag.com/identity/connect/token'                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | auth_data = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     'client_id': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     'client_secret': 'abcd',                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     'grant_type': 'client_credentials',                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     'scope': 'public-api',                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | auth_data_str = '&'.join(f'{k}={v}' for k, v in auth_data.items())                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | auth_response = requests.post(auth_url, data=auth_data_str)                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | auth_response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | token = auth_response.json()['access_token']                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | df = pd.DataFrame()                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | Regions = ['RSE']                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | #versions = ['FC1', 'ACT', 'FC1 INT', 'BU2']                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | def fetch_data(Region):                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     api_url = f'https://planx.hlag.com/public/PlanX_CL_Scheme/query/testing2?year="2023"&Currency="USD"&Region={Region}&Layer 2="HL"&CL Scheme Hierarchy="030"&CL Scheme Type="020"'                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     headers = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |         'Authorization': f'Bearer {token}',                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |         'Client-ID': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     }                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     response = requests.get(api_url, headers=headers)                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     data = response.json()                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     temp_df = pd.DataFrame(data['data'], columns=['Month', 'Version', 'Layer Level 3','Currency', 'CL Scheme', 'Relation', 'REP CL Scheme'])                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     if temp_df.empty:                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |         return None                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     return temp_df                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | for Region in Regions:                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |         temp_df = fetch_data(Region)                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |         if temp_df is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |             df = pd.concat([df, temp_df])                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | del temp_df                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | df                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
| 1184 | 4898c579-fc81-46b5-b796-4371fcb4c9f1 | assistant     |   1.68976e+09 | First, let's import the required libraries and define the function to connect to the SQL Server database:                                                                                                                                                                                                                                                                                                                                                                        | finished_successfully | aaa2315c-028b-4fd3-845c-ea010cfb1c6b |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | import pyodbc                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | import pandas as pd                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | import requests                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | from datetime import datetime                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | from getpass import getuser                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Function to create a database connection                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | def create_connection(server_name, database_name, username, password):                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     connection_string = f'DRIVER={{SQL Server}};SERVER={server_name};DATABASE={database_name};UID={username};PWD={password};'                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     cnxn = pyodbc.connect(connection_string)                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     return cnxn                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Next, we define a function that checks if the API call limit has been exceeded:                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | # Function to check if the API call limit has been exceeded                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | def check_api_call_limit(cnxn, region, user_id):                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     sql_query = f"""                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     SELECT SUM(No_Of_Calls) as Total_Calls                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     FROM [sta].[PowerBI_Calls]                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |     WHERE Region_Name = '{region}' AND User_ID = '{user_id}' AND Call_DateTime >= DATEADD(day, -1, GETDATE())                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     """                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     df_calls = pd.read_sql(sql_query, cnxn)                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     total_calls = df_calls.loc[0, 'Total_Calls']                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     sql_query = f"""                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     SELECT Max_API_Calls                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     FROM sta.PowerBI_Users                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     WHERE Region_Name = '{region}' AND User_ID = '{user_id}'                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     """                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     df_max_calls = pd.read_sql(sql_query, cnxn)                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     max_calls = df_max_calls.loc[0, 'Max_API_Calls']                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     return total_calls >= max_calls                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | This function first calculates the total number of API calls made in the last 24 hours. Then, it retrieves the maximum number of API calls allowed for the given region and user. If the total number of calls is equal to or more than the maximum, the function returns `True`; otherwise, it returns `False`.                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | We also need a function to record the API calls:                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | # Function to record the API calls                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | def record_api_call(cnxn, region, user_id, api_url, no_of_calls):                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     cursor = cnxn.cursor()                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     query = f"""                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     INSERT INTO [sta].[PowerBI_Calls] (Region_Name, User_ID, Query_ur, Call_DateTime, No_Of_Calls)                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     VALUES ('{region}', '{user_id}', '{api_url}', GETDATE(), {no_of_calls})                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |     """                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     cursor.execute(query)                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |     cnxn.commit()                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | This function inserts a new row into the `PowerBI_Calls` table every time an API call is made.                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Now, we can use these functions in the main part of the code:                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | # Define the connection details                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | server_name = 'your_server_name'                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | database_name = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | username = 'PowerBI_user'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | password = 'your_password'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Create a database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | cnxn = create_connection(server_name, database_name, username, password)                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | auth_url = 'https://planx.hlag.com/identity/connect/token'                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | auth_data = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     'client_id': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     'client_secret': 'abcd',                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     'grant_type': 'client_credentials',                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     'scope': 'public-api',                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | auth_data_str = '&'.join(f'{k}={v}' for k, v in auth_data.items())                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | auth_response = requests.post(auth_url, data=auth_data_str)                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | auth_response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | token = auth_response.json()['access_token']                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | df = pd.DataFrame()                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | Regions = ['RSE']                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | def fetch_data(Region):                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     api_url = f'https://planx.hlag.com/public/PlanX_CL_Scheme/query/testing2?year="2023"&Currency="USD"&Region={Region}&Layer 2="HL"&CL Scheme Hierarchy="030"&CL Scheme Type="020"'                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     headers = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |         'Authorization': f'Bearer {token}',                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |         'Client-ID': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |     }                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     response = requests.get(api_url, headers=headers)                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |     response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     data = response.json()                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |     temp_df = pd.DataFrame(data['data'], columns=['Month', 'Version', 'Layer Level 3','Currency', 'CL Scheme', 'Relation', 'REP CL Scheme'])                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     if temp_df.empty:                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |         return None                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     return temp_df                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | for Region in Regions:                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     # Get Windows User ID                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |     user_id = getuser()                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # Check if the API call limit has been exceeded                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     if check_api_call_limit(cnxn, Region, user_id):                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |         print(pd.DataFrame({'permission': ['you are exceeding today no of calls']}))                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     else:                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |         temp_df = fetch_data(Region)                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |         if temp_df is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |             df = pd.concat([df, temp_df])                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |             # Record the API call                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |             record_api_call(cnxn, Region, user_id, api_url, len(temp_df))                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | del temp_df                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | df                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Please replace `'your_server_name'` and `'your_password'` with your actual SQL Server name and password respectively. Make sure to keep the code secure by not revealing the server name, user credentials, or any other sensitive information.                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Also note that the `getuser()` function used to get the Windows User ID works for the user running the script, but it may not return the correct value if the script is running in some types of container or service environment.                                                                                                                                                                                                                                               |                       |                                      |
| 1185 | aaa21e8e-6451-432b-bb69-fd6ceba3070f | user          |   1.68976e+09 | NameError: name 'api_url' is not defined                                                                                                                                                                                                                                                                                                                                                                                                                                         | finished_successfully | 4898c579-fc81-46b5-b796-4371fcb4c9f1 |
| 1186 | ce5ad31b-f342-4a10-a6b4-34707ce10c67 | assistant     |   1.68976e+09 | I apologize for the oversight. The `api_url` is defined inside the `fetch_data` function, but it's not available in the outer scope where `record_api_call` is called. We can move the definition of `api_url` outside of the `fetch_data` function so that it is available in the outer scope. Here's the corrected code:                                                                                                                                                       | finished_successfully | aaa21e8e-6451-432b-bb69-fd6ceba3070f |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | # Define the connection details                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | server_name = 'your_server_name'                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | database_name = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | username = 'PowerBI_user'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | password = 'your_password'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Create a database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | cnxn = create_connection(server_name, database_name, username, password)                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | auth_url = 'https://planx.hlag.com/identity/connect/token'                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | auth_data = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     'client_id': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     'client_secret': 'abcd',                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     'grant_type': 'client_credentials',                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     'scope': 'public-api',                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | auth_data_str = '&'.join(f'{k}={v}' for k, v in auth_data.items())                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | auth_response = requests.post(auth_url, data=auth_data_str)                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | auth_response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | token = auth_response.json()['access_token']                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | df = pd.DataFrame()                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | Regions = ['RSE']                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | for Region in Regions:                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     # Get Windows User ID                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |     user_id = getuser()                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # Define the API URL                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     api_url = f'https://planx.hlag.com/public/PlanX_CL_Scheme/query/testing2?year="2023"&Currency="USD"&Region={Region}&Layer 2="HL"&CL Scheme Hierarchy="030"&CL Scheme Type="020"'                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # Check if the API call limit has been exceeded                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     if check_api_call_limit(cnxn, Region, user_id):                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |         print(pd.DataFrame({'permission': ['you are exceeding today no of calls']}))                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     else:                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |         headers = {                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |             'Authorization': f'Bearer {token}',                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |             'Client-ID': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |         }                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |         response = requests.get(api_url, headers=headers)                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |         response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |         data = response.json()                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |         temp_df = pd.DataFrame(data['data'], columns=['Month', 'Version', 'Layer Level 3','Currency', 'CL Scheme', 'Relation', 'REP CL Scheme'])                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |         if temp_df is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |             df = pd.concat([df, temp_df])                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |             # Record the API call                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |             record_api_call(cnxn, Region, user_id, api_url, len(temp_df))                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | del temp_df                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | df                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | As before, please replace `'your_server_name'` and `'your_password'` with your actual SQL Server name and password respectively. Keep the code secure by not revealing the server name, user credentials, or any other sensitive information. Also note that the `getuser()` function used to get the Windows User ID works for the user running the script, but it may not return the correct value if the script is running in some types of container or service environment. |                       |                                      |
| 1187 | aaa2f888-d0be-44c7-9806-9c85fa5b1dfc | user          |   1.68976e+09 | the no of calls that has been recooreded in SQL table is not correct as given me 206668 and the actual no of calls should be count as 1                                                                                                                                                                                                                                                                                                                                          | finished_successfully | ce5ad31b-f342-4a10-a6b4-34707ce10c67 |
| 1188 | 97ed18bc-27ea-4eb7-9c26-d9b94d9e2634 | assistant     |   1.68976e+09 | I see where the confusion might be coming from. In the `record_api_call` function, the `no_of_calls` parameter is being set to the length of the `temp_df` DataFrame:                                                                                                                                                                                                                                                                                                            | finished_successfully | aaa2f888-d0be-44c7-9806-9c85fa5b1dfc |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | # Record the API call                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | record_api_call(cnxn, Region, user_id, api_url, len(temp_df))                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | However, the length of `temp_df` does not represent the number of API calls, but rather the number of rows in the DataFrame. Since each API call seems to return a single DataFrame (regardless of the number of rows in that DataFrame), you should record the number of API calls as 1 for each call made.                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Here's how you would modify the call to `record_api_call`:                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | # Record the API call                                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               | record_api_call(cnxn, Region, user_id, api_url, 1)  # Set no_of_calls to 1                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | With this modification, the `no_of_calls` field in your SQL table will accurately reflect the number of API calls made.                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
| 1189 | aaa28bac-367b-4373-b5fb-6f6f1270a701 | user          |   1.68976e+09 | but sometime we have a for loop in API calls like below , so we need to be sure and adjust the no of calls based on teh actual no of calls :                                                                                                                                                                                                                                                                                                                                     | finished_successfully | 97ed18bc-27ea-4eb7-9c26-d9b94d9e2634 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | df = pd.DataFrame()                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | months = ['202301', '202302', '202303', '202304']                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | versions = [ 'FC1', 'ACT', 'FC1 INT', 'BU2']                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | for month in months:                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     for version in versions:                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |         temp_df = fetch_data(month, version)                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |         if temp_df is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |             df = pd.concat([df, temp_df])                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
| 1190 | 77d8b386-c5c1-4f78-8efd-59de6a65f7f8 | assistant     |   1.68976e+09 | In this case, the number of API calls is equal to the number of iterations in the nested for loop, since each iteration makes a call to the `fetch_data` function, which then makes an API call. You can update the `no_of_calls` in the `record_api_call` function call inside the nested for loop. Here's how you can modify the script:                                                                                                                                       | finished_successfully | aaa28bac-367b-4373-b5fb-6f6f1270a701 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | df = pd.DataFrame()                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | months = ['202301', '202302', '202303', '202304']                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | versions = [ 'FC1', 'ACT', 'FC1 INT', 'BU2']                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | for month in months:                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     for version in versions:                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |         # Get Windows User ID                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |         user_id = getuser()                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |         # Define the API URL                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |         api_url = f'https://planx.hlag.com/public/PlanX_CL_Scheme/query/testing2?year={month}&Currency="USD"&Version={version}&Layer 2="HL"&CL Scheme Hierarchy="030"&CL Scheme Type="020"'                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |         # Check if the API call limit has been exceeded                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |         if check_api_call_limit(cnxn, Region, user_id):                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |             print(pd.DataFrame({'permission': ['you are exceeding today no of calls']}))                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |         else:                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |             headers = {                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                 'Authorization': f'Bearer {token}',                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                 'Client-ID': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |             }                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |             response = requests.get(api_url, headers=headers)                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |             response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |             data = response.json()                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |             temp_df = pd.DataFrame(data['data'], columns=['Month', 'Version', 'Layer Level 3','Currency', 'CL Scheme', 'Relation', 'REP CL Scheme'])                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |             if temp_df is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                 df = pd.concat([df, temp_df])                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |                 # Record the API call                                                                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |                 record_api_call(cnxn, Region, user_id, api_url, 1)  # Set no_of_calls to 1                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | df                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | In this updated code, the number of API calls is still set to 1 in the `record_api_call` function, but now that call is made inside the nested for loop, so it will be executed for each API call. As a result, the `no_of_calls` column in your SQL table will correctly record the number of API calls made.                                                                                                                                                                   |                       |                                      |
| 1191 | aaa2a089-74af-4397-9421-d4d0c627fac1 | user          |   1.68976e+09 | after adjusting as per above i got below error :                                                                                                                                                                                                                                                                                                                                                                                                                                 | finished_successfully | 97ed18bc-27ea-4eb7-9c26-d9b94d9e2634 |
|      |                                      |               |               | NameError: name 'temp_df' is not defined                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
| 1192 | d285bdf5-510c-4bdf-a01e-b24818969504 | assistant     |   1.68976e+09 | My apologies for that confusion. It seems like there was a problem with the location of the `del temp_df` line. In the previous examples, the `del temp_df` line is outside of the loop, which means it tries to delete the `temp_df` variable even if it's not defined (which happens when all the API calls return empty dataframes).                                                                                                                                          | finished_successfully | aaa2a089-74af-4397-9421-d4d0c627fac1 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | To fix this issue, we should put the `del temp_df` line inside the loop, and also add a check to make sure `temp_df` exists before trying to delete it. Here's how to do it:                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | # Define the connection details                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | server_name = 'your_server_name'                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | database_name = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | username = 'PowerBI_user'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | password = 'your_password'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Create a database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | cnxn = create_connection(server_name, database_name, username, password)                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | auth_url = 'https://planx.hlag.com/identity/connect/token'                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | auth_data = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     'client_id': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     'client_secret': 'abcd',                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     'grant_type': 'client_credentials',                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     'scope': 'public-api',                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | auth_data_str = '&'.join(f'{k}={v}' for k, v in auth_data.items())                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | auth_response = requests.post(auth_url, data=auth_data_str)                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | auth_response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | token = auth_response.json()['access_token']                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | df = pd.DataFrame()                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | Regions = ['RSE']                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | for Region in Regions:                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     # Get Windows User ID                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |     user_id = getuser()                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # Define the API URL                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     api_url = f'https://planx.hlag.com/public/PlanX_CL_Scheme/query/testing2?year="2023"&Currency="USD"&Region={Region}&Layer 2="HL"&CL Scheme Hierarchy="030"&CL Scheme Type="020"'                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # Check if the API call limit has been exceeded                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     if check_api_call_limit(cnxn, Region, user_id):                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |         print(pd.DataFrame({'permission': ['you are exceeding today no of calls']}))                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |     else:                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |         headers = {                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |             'Authorization': f'Bearer {token}',                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |             'Client-ID': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |         }                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |         response = requests.get(api_url, headers=headers)                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |         response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |         data = response.json()                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |         temp_df = pd.DataFrame(data['data'], columns=['Month', 'Version', 'Layer Level 3','Currency', 'CL Scheme', 'Relation', 'REP CL Scheme'])                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |         if temp_df is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |             df = pd.concat([df, temp_df])                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |             # Record the API call                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |             record_api_call(cnxn, Region, user_id, api_url, 1)  # Set no_of_calls to 1                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |         # Check if temp_df exists before trying to delete it                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |         if 'temp_df' in locals():                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |             del temp_df                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | df                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Now, this script should only attempt to delete `temp_df` if it has been defined in the current loop iteration. As before, please replace `'your_server_name'` and `'your_password'` with your actual SQL Server name and password respectively.                                                                                                                                                                                                                                  |                       |                                      |
| 1193 | aaa2465e-2fa9-490e-82ff-2cc081ea2542 | user          |   1.68976e+09 | can you adjust below part instead of print to be df:                                                                                                                                                                                                                                                                                                                                                                                                                             | finished_successfully | d285bdf5-510c-4bdf-a01e-b24818969504 |
|      |                                      |               |               |   # Check if the API call limit has been exceeded                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |     if check_api_call_limit(cnxn, Region, user_id):                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |         #print(pd.DataFrame({'permission': ['you are exceeding today no of calls']}))                                                                                                                                                                                                                                                                                                                                                                                            |                       |                                      |
|      |                                      |               |               |         df = pd.DataFrame({'permission': ['you are exceeding today no of calls']})                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
| 1194 | 1e4aa256-b549-49b3-8cfd-2ba39d965d13 | assistant     |   1.68976e+09 | Absolutely, I've adjusted the code block as per your requirement. Here it is:                                                                                                                                                                                                                                                                                                                                                                                                    | finished_successfully | aaa2465e-2fa9-490e-82ff-2cc081ea2542 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | # Define the connection details                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | server_name = 'your_server_name'                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | database_name = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | username = 'PowerBI_user'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | password = 'your_password'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Create a database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | cnxn = create_connection(server_name, database_name, username, password)                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | auth_url = 'https://planx.hlag.com/identity/connect/token'                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | auth_data = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     'client_id': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     'client_secret': 'abcd',                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     'grant_type': 'client_credentials',                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     'scope': 'public-api',                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | auth_data_str = '&'.join(f'{k}={v}' for k, v in auth_data.items())                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | auth_response = requests.post(auth_url, data=auth_data_str)                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | auth_response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | token = auth_response.json()['access_token']                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | df = pd.DataFrame()                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | Regions = ['RSE']                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | for Region in Regions:                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     # Get Windows User ID                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |     user_id = getuser()                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # Define the API URL                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     api_url = f'https://planx.hlag.com/public/PlanX_CL_Scheme/query/testing2?year="2023"&Currency="USD"&Region={Region}&Layer 2="HL"&CL Scheme Hierarchy="030"&CL Scheme Type="020"'                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # Check if the API call limit has been exceeded                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     if check_api_call_limit(cnxn, Region, user_id):                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |         df = pd.DataFrame({'permission': ['you are exceeding today no of calls']})                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     else:                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |         headers = {                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |             'Authorization': f'Bearer {token}',                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |             'Client-ID': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |         }                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |         response = requests.get(api_url, headers=headers)                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |         response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |         data = response.json()                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |         temp_df = pd.DataFrame(data['data'], columns=['Month', 'Version', 'Layer Level 3','Currency', 'CL Scheme', 'Relation', 'REP CL Scheme'])                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |         if temp_df is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |             df = pd.concat([df, temp_df])                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |             # Record the API call                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |             record_api_call(cnxn, Region, user_id, api_url, 1)  # Set no_of_calls to 1                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |         # Check if temp_df exists before trying to delete it                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |         if 'temp_df' in locals():                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |             del temp_df                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | df                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | As before, replace `'your_server_name'` and `'your_password'` with your actual SQL Server name and password. Now the DataFrame `df` will contain the 'exceeded calls' message if the API call limit has been exceeded. Otherwise, it will contain the data fetched from the API.                                                                                                                                                                                                 |                       |                                      |
| 1195 | aaa20b16-f3ad-47b1-b3b6-235ef78b8073 | user          |   1.68976e+09 | AttributeError: 'DataFrame' object has no attribute 'DataFrame'                                                                                                                                                                                                                                                                                                                                                                                                                  | finished_successfully | 1e4aa256-b549-49b3-8cfd-2ba39d965d13 |
| 1196 | fed1e113-ebc5-4cc3-9030-b428398eaed5 | assistant     |   1.68976e+09 | My apologies for the oversight. The error arises because we're trying to invoke DataFrame as an attribute of the df object, which is already a DataFrame.                                                                                                                                                                                                                                                                                                                        | finished_successfully | aaa20b16-f3ad-47b1-b3b6-235ef78b8073 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | The correct syntax to create a new DataFrame is:                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | df = pd.DataFrame({'permission': ['you are exceeding today no of calls']})                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Here is the corrected version of the code:                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | ```python                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | # Define the connection details                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | server_name = 'your_server_name'                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | database_name = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | username = 'PowerBI_user'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | password = 'your_password'                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Create a database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | cnxn = create_connection(server_name, database_name, username, password)                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | auth_url = 'https://planx.hlag.com/identity/connect/token'                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | auth_data = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     'client_id': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     'client_secret': 'abcd',                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     'grant_type': 'client_credentials',                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     'scope': 'public-api',                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | auth_data_str = '&'.join(f'{k}={v}' for k, v in auth_data.items())                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | auth_response = requests.post(auth_url, data=auth_data_str)                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | auth_response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | token = auth_response.json()['access_token']                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | df = pd.DataFrame()                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | Regions = ['RSE']                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | for Region in Regions:                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     # Get Windows User ID                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |     user_id = getuser()                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # Define the API URL                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     api_url = f'https://planx.hlag.com/public/PlanX_CL_Scheme/query/testing2?year="2023"&Currency="USD"&Region={Region}&Layer 2="HL"&CL Scheme Hierarchy="030"&CL Scheme Type="020"'                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # Check if the API call limit has been exceeded                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     if check_api_call_limit(cnxn, Region, user_id):                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |         df = pd.DataFrame({'permission': ['you are exceeding today no of calls']})                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     else:                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |         headers = {                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |             'Authorization': f'Bearer {token}',                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |             'Client-ID': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |         }                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |         response = requests.get(api_url, headers=headers)                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |         response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |         data = response.json()                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |         temp_df = pd.DataFrame(data['data'], columns=['Month', 'Version', 'Layer Level 3','Currency', 'CL Scheme', 'Relation', 'REP CL Scheme'])                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |         if temp_df is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |             df = pd.concat([df, temp_df])                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |             # Record the API call                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |             record_api_call(cnxn, Region, user_id, api_url, 1)  # Set no_of_calls to 1                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |         # Check if temp_df exists before trying to delete it                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |         if 'temp_df' in locals():                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |             del temp_df                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | df                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | ```                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | Please replace `'your_server_name'` and `'your_password'` with your actual SQL Server name and password. This version of the script will correctly create a new DataFrame if the API call limit has been exceeded.                                                                                                                                                                                                                                                               |                       |                                      |
| 1197 | aaa26eff-1043-4590-9a09-b6d4cb887814 | user          |   1.68976e+09 | AttributeError                            Traceback (most recent call last)                                                                                                                                                                                                                                                                                                                                                                                                      | finished_successfully | fed1e113-ebc5-4cc3-9030-b428398eaed5 |
|      |                                      |               |               | Cell In[25], line 22                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |      19 auth_response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |      20 token = auth_response.json()['access_token']                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               | ---> 22 df = pd.DataFrame()                                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |      23 Regions = ['RSE']                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |      25 for Region in Regions:                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |      26     # Get Windows User ID                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | File c:\Users\IBRAHHO\Anaconda3\envs\Prod\lib\site-packages\pandas\core\generic.py:5902, in NDFrame.__getattr__(self, name)                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |    5895 if (                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |    5896     name not in self._internal_names_set                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |    5897     and name not in self._metadata                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |    5898     and name not in self._accessors                                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               |    5899     and self._info_axis._can_hold_identifiers_and_holds_name(name)                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |    5900 ):                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               |    5901     return self[name]                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               | -> 5902 return object.__getattribute__(self, name)                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | AttributeError: 'DataFrame' object has no attribute 'DataFrame'                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
| 1198 | a80c8c61-018b-4904-91ff-b1141b731272 | assistant     |   1.68976e+09 | The error message suggests that there might be an issue in another part of your code because the line causing the error, `df = pd.DataFrame()`, should not result in such an error.                                                                                                                                                                                                                                                                                              | finished_successfully | aaa26eff-1043-4590-9a09-b6d4cb887814 |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | It's possible that `df` or `pd` is being overwritten somewhere in your code. You might want to check for that.                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | In case that isn't the issue, you could try restarting your Python interpreter/kernel to clear all defined variables and then try again. Sometimes, this error can occur if there's some residual variable or function state that's causing a conflict in your Python environment.                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | If you are using Jupyter notebooks, you can do this by clicking on the "Kernel" option at the top of your notebook, and then clicking on "Restart & Clear Output". After doing this, try to run your code again.                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | If you're still encountering the issue after trying these suggestions, it would be helpful if you could provide more of your code, or more context about where this code is being run and what other code is running alongside it.                                                                                                                                                                                                                                               |                       |                                      |
| 1199 | aaa217cc-182b-46ca-a7b7-cadfe7d001a5 | user          |   1.68976e+09 | here the ful lcode , please corrected :                                                                                                                                                                                                                                                                                                                                                                                                                                          | finished_successfully | a80c8c61-018b-4904-91ff-b1141b731272 |
|      |                                      |               |               | # Define the connection details                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | server_name = 'KFICWPNXDBSP01'                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | database_name = 'PlanX'                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               | username = 'PowerBI_user'                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               | password = r'PowerBI\User@Hossam@HQ1611'                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | # Create a database connection                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               | cnxn = create_connection(server_name, database_name, username, password)                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | auth_url = 'https://planx.hlag.com/identity/connect/token'                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | auth_data = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |                       |                                      |
|      |                                      |               |               |     'client_id': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     'client_secret': 'abcd',                                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |     'grant_type': 'client_credentials',                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |     'scope': 'public-api',                                                                                                                                                                                                                                                                                                                                                                                                                                                       |                       |                                      |
|      |                                      |               |               | }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               | auth_data_str = '&'.join(f'{k}={v}' for k, v in auth_data.items())                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               | auth_response = requests.post(auth_url, data=auth_data_str)                                                                                                                                                                                                                                                                                                                                                                                                                      |                       |                                      |
|      |                                      |               |               | auth_response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               | token = auth_response.json()['access_token']                                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | df = pd.DataFrame()                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               | Regions = ['RSE']                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | for Region in Regions:                                                                                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |     # Get Windows User ID                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |     user_id = getuser()                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # Define the API URL                                                                                                                                                                                                                                                                                                                                                                                                                                                         |                       |                                      |
|      |                                      |               |               |     api_url = f'https://planx.hlag.com/public/PlanX_CL_Scheme/query/testing2?year="2023"&Currency="USD"&Region={Region}&Layer 2="HL"&CL Scheme Hierarchy="030"&CL Scheme Type="020"'                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |     # Check if the API call limit has been exceeded                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |     if check_api_call_limit(cnxn, Region, user_id):                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |         df = pd.DataFrame({'permission': ['you are exceeding today no of calls']})                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |
|      |                                      |               |               |     else:                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |         headers = {                                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |             'Authorization': f'Bearer {token}',                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |             'Client-ID': 'API_User',                                                                                                                                                                                                                                                                                                                                                                                                                                             |                       |                                      |
|      |                                      |               |               |         }                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |         response = requests.get(api_url, headers=headers)                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |         response.raise_for_status()                                                                                                                                                                                                                                                                                                                                                                                                                                              |                       |                                      |
|      |                                      |               |               |         data = response.json()                                                                                                                                                                                                                                                                                                                                                                                                                                                   |                       |                                      |
|      |                                      |               |               |         temp_df = pd.DataFrame(data['data'], columns=['Month', 'Version', 'Layer Level 3','Currency', 'CL Scheme', 'Relation', 'REP CL Scheme'])                                                                                                                                                                                                                                                                                                                                 |                       |                                      |
|      |                                      |               |               |         if temp_df is not None:                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |             df = pd.concat([df, temp_df])                                                                                                                                                                                                                                                                                                                                                                                                                                        |                       |                                      |
|      |                                      |               |               |             # Record the API call                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |             record_api_call(cnxn, Region, user_id, api_url, 1)  # Set no_of_calls to 1                                                                                                                                                                                                                                                                                                                                                                                           |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               |         # Check if temp_df exists before trying to delete it                                                                                                                                                                                                                                                                                                                                                                                                                     |                       |                                      |
|      |                                      |               |               |         if 'temp_df' in locals():                                                                                                                                                                                                                                                                                                                                                                                                                                                |                       |                                      |
|      |                                      |               |               |             del temp_df                                                                                                                                                                                                                                                                                                                                                                                                                                                          |                       |                                      |
|      |                                      |               |               |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |                       |                                      |
|      |                                      |               |               | df                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |                       |                                      |

